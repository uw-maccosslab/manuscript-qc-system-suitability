---
title: "Figures 3, 4, 5, 6, and S1 from MacCoss QC manuscript"
author: "Kristine A. Tsantilas, PhD"
date: '2024-04-04'
output: 
  html_document:
      code_folding: hide
      toc: true
      toc_float:
        collapsed: false
editor_options: 
  chunk_output_type: inline
---



# Overview

This R Markdown file generates Figures 3, 4, 5, and 6 and Supplementary Figure 1 from the MacCoss laboratory's manuscript describing approaches to quality control spanning sample preparation, system suitability, and quantitative results. 

<br/><br/>

## Experiments

Summary of figures included in the preprint:.

* **Figure 1:** Visual summary of the QCs discussed in the manuscript. No experiments, and not generated by this script.

* **Figure 2:** System suitability run by multiple technicians before, during, and after multiple experiments. Not generated by this script.

* **Figure 3:** DDA and PRM system suitability runs on the same system over several years.

* **Figure 4:** DIA sample runs where one of four sample digestion conditions resulted in loss of sample signal.

* **Figure 5:** DIA sample runs where one injection had altered retention times and significantly reduced signal due to an LC failure.

* **Figure 6:** DIA samples and system suitability runs on the same system used to identify a severe instrument defect.

* **Figure 7:** External quality control DIA runs used to assess quantitative results. Not generated by this script

* **Supplementary Figure 1:** Expanded figure panels containing same data as Figure 4, but adding PRTC peptides and an additional enolase peptide.

<br/><br/>

# Script {.tabset .tabset-fade}

## Input

The necessary input files by figure are listed below: 

#### Figure 3

* **figure3_PRM_system_suitability.sky.zip** 

  - **Figure3_PRM_metadata.csv:** Metadata of PRM system suitability runs.
  
  - **Figure3_PRM_MS1area_idotp.csv:** Isotope dot products from PRM system suitability runs
  
  - **Figure3_PRM_PeakArea_RetTime_Chromatogram_Export.csv:** Peak areas, retention times, and chromatography data from PRM system suitability runs
  
* **Limelight Project 131** 

  - **Figure3_DDA_Limelight_PSMs.txt:** Organizer .csv to set-up and label Figure 6A.



#### Figure 4

* **figure4_PRM_system_suitability.sky.zip** 

  - **Figure4_PRM_PeakArea_RetTime_Chromatogram_Export.csv:** Peak areas, retention times, and chromatography data from PRM system suitability runs
  
  - **Figure4_PRM_metadata.csv:** Metadata of PRM system suitability runs.
  
* **figure4_DIA_samples.sky.zip** 

  - **Figure4_DIA_PeakArea_RetTime_Chromatogram_Export.csv:** Peak areas, retention times, and chromatography data from DIA sample runs.

  - **Figure4_DIA_metadata.csv:** Metadata of DIA samples runs.

  
#### Figure 5

  - **Figure5_PRM_PeakArea_RetTime_Chromatogram_Export.csv:** Peak areas, retention times, and chromatography data from PRM system suitability runs.
  
  - **Figure5_DIA_PeakArea_RetTime_Chromatogram_Export.csv:** Peak areas, retention times, and chromatography data from DIA sample runs.
  
  - **Figure5_PRM_metadata.csv:** Metadata of PRM system suitability runs.
  
  - **Figure5_DIA_metadata.csv:** Metadata of DIA samples runs.

  
#### Figure 6
  
  - **Figure6_DIA_LongForm_Peptide_TAF.csv:** Skyline document grid exported .csv of total area fragments of DIA sample runs
  
  - **Figure6_PRM_LongForm_Peptide_TAF.csv:** Skyline document grid exported .csv of total area fragments of PRM system suitability runs.
  
  - **Figure6_DIA_metadata.csv:** Metadata of DIA samples runs.
  
  - **Figure6_PRM_metadata.csv:** Metadata of PRM system suitability runs.
  
  - **Figure6_timeline_format.csv:** Organizer .csv to set-up and label Figure 6A.
  
  - **Figure6_Run_Organizer.csv:** Organizer .csv to set-up and label Figure 6B.
  

<br/><br/>


## Output

The resulting output files by figure are listed below: 

* **Figure 3:** Figure3.svg

* **Figure 4:** Figure4.svg

* **Figure 5:** Figure5.svg

* **Figure 6:** Figure6.svg


<br/><br/>


## Software Information

* Skyline Daily (64-bit): Documents exported with compatibility for stable release 22.2.

* R version: 4.1.2

* R Studio version: 2023.03.0+386 "Cherry Blossom" Release (3c53477afb13ab959aeb5b34df1f10c237b256c3, 2023-03-09) for Windows
Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) RStudio/2023.03.0+386 Chrome/108.0.5359.179 Electron/22.0.3 Safari/537.36

* Packages required: 

  + knitr (version 1.43)

  + kableExtra (version 1.3.4)
  
  + dplyr (version 1.1.2)
  
  + stringr (version 1.5.0)
  
  + tidyr (version 1.3.0)
  
  + matrixStats (version 0.63.0)
  
  + tibble (version 3.2.1)
  
  + ggplot2 (version 3.4.2)
  
  + forcats (version 1.0.0)
  
  + ggnewscale (version 0.4.9)
  
  + RColorBrewer (version 1.1-3)
  
  + magick (version 2.7.4)
  
  + patchwork (version 1.1.2)


<br/><br/>

```{r setup}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, warning=FALSE, message=FALSE)

```


```{r package_installation, include=FALSE}
# Download necessary packages for analysis
library(knitr)
library(kableExtra)
library(dplyr)
library(stringr)
library(tidyr)
library(matrixStats)
library(tibble)
library(ggplot2)
library(magick)
library(patchwork)

sessionInfo()

```

```{r setup_folders}

directories <- c('output', 'output/figures')

for(c in directories){
  if(!dir.exists(c)){
    message(paste('Creating directory: ', c))
    dir.create(c)
  }}

```


```{r filename_labels, results='hide'}

# Check location of working directory
getwd()

# Set-up current date to include in filename output
(today <- Sys.Date())
basename <- today %>%
            format(., "%Y%b%d") %>% # with month as a word
            paste0(.,"_")

# Set-up base filenames by dataset to classify filename output
filenamebase <- "MacCossQC_"
```


<br/><br/>


## Internal Quality Controls

Summary of peptides used as part of the internal quality controls (introduced at protein or peptide level) to monitor data and sample quality in this study.

* SS = System Suitability (PRM)
 
* IQC = Internal Quality Controls (DIA) in sample runs

$~$

```{r internal_control_peps, results='hide'}

# Vector of all PRTC peptides considered in study
PRTC <- c("SSAAPPPPPR",
              "GISNEGQNASIK",
              "HVLTSIGEK",
              "DIPVPKPK",
              "IGDYAGIK",
              "TASEFDSAIAQDK",
              "SAAGAFGPELSR",
              "ELGQSGVDTYLQTK",
              "GLILVGGYGTR",
              "GILFVGSGVSGGEEGAR",
              "SFANQPLEVVYSK",
              "LTILEELR",
              "NGFILDGFPR",
              "ELASGLSFPVGFK",
              "LSSEAPALFQFDLK")  

YENO1 <- c("NVNDVIAPAFVK", "AVDDFLISLDGTANK", "LGANAILGVSLAASR", "TAGIQIVADDLTVTNPK", "AADALLLK", "VNQIGTLSESIK")

BSA <- c("LVNELTEFAK", "ATEEQLK")


PRTC_tab <- as.data.frame(PRTC)
PRTC_tab <- PRTC_tab %>%
            rename("Peptide Sequence" = "PRTC") %>%
            mutate("Peptide Source" = "PRTC",
                   "Run Type" = "SS, IQC")

BSA_tab <- as.data.frame(BSA)
BSA_tab <- BSA_tab %>%
            rename("Peptide Sequence" = "BSA") %>%
            mutate("Peptide Source" = "BSA",
                   "Run Type" = "SS")

YENO1_tab <- as.data.frame(YENO1)
YENO1_tab <- YENO1_tab %>%
            rename("Peptide Sequence" = "YENO1") %>%
            mutate("Peptide Source" = "YENO1",
                   "Run Type" = "IQC")

all_qc <- rbind(PRTC_tab, BSA_tab, YENO1_tab)

```


```{r iqc_print}
# Table of all internal quality control peptides considered in study.
knitr::kable(all_qc, caption = "Internal QC Peptides", booktabs = TRUE, linesep = "", align = 'l') %>%
  kable_styling(latex_options = "scale_down", font_size = 12) %>%
  scroll_box(height = "350px")
```

<br/><br/>


## File Import

Importing data files.

$~$

```{r files, results='hide', collapse = TRUE}
 
## Read in data exported from Skyline, metadata, and additional tables (.csv files) to organize figure panels


## Figure 3
    fig3_dda <- read.table("input\\Figure3_DDA_Limelight_PSMs.txt", 
                                header = TRUE,
                                sep = "\t")

    fig3_prm_rt_chrom <- read.csv("input\\Figure3_PRM_PeakArea_RetTime_Chromatogram_Export.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")

    fig3_prm_ms1_idotp <- read.csv("input\\Figure3_PRM_MS1area_idotp.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")

    fig3_prm_metadata <- read.csv("input\\Figure3_PRM_metadata.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")

## Figure 4
    # Long-format file containing peak areas, retention times, and chromatogram intensities/times to make reproducible figure replicating skyline panels
    fig4_pa_rt_chrom <- read.csv("input\\Figure4_DIA_PeakArea_RetTime_Chromatogram_Export.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")

    # Metadata for Figure 4
      fig4_meta <- read.csv("input\\Figure4_DIA_metadata.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")
  
       
## Figure 5
    # Long-format file containing peak areas, retention times, and chromatogram intensities/times to make reproducible figure replicating skyline panels
      fig5_pa_rt_chrom <- read.csv("input\\Figure5_DIA_PeakArea_RetTime_Chromatogram_Export.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")

    # Metadata for Figure 5
      fig5_meta <- read.csv("input\\Figure5_DIA_metadata.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")
          

## Figure 6
    # Table to organize subset of runs plotted in Figure 6. Note that all runs are available on Panorama - only subset plotted here to improve visualization.
    organizer <- read.csv("input\\Figure6_Run_Organizer.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")

    # Table to format maintenance timeline that is used in panel 6A
      fig6_timeline <- read.csv("input\\Figure6_timeline_format.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")

    # Import system suitability controls from PRM runs.
      SS_TAF <- read.csv("input\\Figure6_PRM_LongForm_Peptide_TAF.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")
            SS_TAF <- SS_TAF %>%
                       mutate(Group = "SS")

            
    # Import internal quality controls from DIA runs.
      IQC_TAF <- read.csv("input\\Figure6_DIA_LongForm_Peptide_TAF.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")
            IQC_TAF <- IQC_TAF %>%
                       mutate(Group = "IQC")
            
    # Import system suitability controls from PRM runs.
      SS_meta <- read.csv("input\\Figure6_PRM_metadata.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")
            SS_meta <- SS_meta %>%
                       rename("Batch" = "Group")

    # Import internal quality controls from DIA runs.
      IQC_meta <- read.csv("input\\Figure6_DIA_metadata.csv",
                                  header = TRUE,
                                  na.strings="#N/A",
                                  sep = ",")
            IQC_meta <- IQC_meta %>%
                       rename("Batch" = "Group")

```


<br/><br/>


# Figure 3 {.tabset .tabset-fade}


<br/><br/>

## Tidying

DDA runs: Simplifying column names and batch names. Calculating averages and standard deviations of peptide identifications and PSMs.

$~$

```{r fig3_dda_data_tidying, results = "hold", collapse = TRUE}
fig3_batches <- c("2014_12","2015_4", "2015_5", "2016_2", "2016_3")
          
    fig3_dda_L <- fig3_dda %>% 
                      rename(.,
                             "Proteins" = "Protein.s.",
                             "2014_12-1" = "PSMs..4_12_1.p.",
                             "2014_12-2" = "PSMs..4_12_2.p.",
                             "2014_12-3" = "PSMs..4_12_3.p.",
                             "2015_4-1" = "PSMs..5_4_1.pe.",
                             "2015_4-2" = "PSMs..5_4_2.pe.",
                             "2015_4-3" = "PSMs..5_4_3.pe.",
                             "2016_2-1" = "PSMs..6_2_1.pe.",
                             "2016_2-2" = "PSMs..6_2_2.pe.",
                             "2016_2-3" = "PSMs..6_2_3.pe.",
                             "2016_3-1" = "PSMs..6_3_1.pe.",
                             "2016_3-2" = "PSMs..6_3_2.pe.",
                             "2016_3-3" = "PSMs..6_3_3.pe.") %>%
                      gather(., Replicate, PSMs_ByRep, "2014_12-1":"2016_3-3", factor_key=FALSE) %>%
                      mutate(.,
                             Batch = str_extract(Replicate, "(?:(?!-).)*"))


fig3_dda_L$Batch <- factor(fig3_dda_L$Batch, levels=c("2014_12","2015_4","2016_2", "2016_3"))
levels(fig3_dda_L$Batch) <- list("2014" = "2014_12",
                                 "2015" = "2015_4", 
                                 "2016-1" = "2016_2", 
                                 "2016-2" = "2016_3")

    
fig3_dda_psms <- fig3_dda_L %>%
                        group_by(Replicate) %>%
                        reframe(Replicate = unique(Replicate),
                                Batch = unique(Batch),
                                SumPSM = sum(PSMs_ByRep))

fig3_dda_pep <- fig3_dda_L %>%
                        filter(PSMs_ByRep != "0") %>%
                        group_by(Replicate) %>%
                        reframe(Replicate = unique(Replicate),
                                Batch = unique(Batch),
                                Num_Peptides = n_distinct(Peptide.Sequence))

fig3_dda_psms_summary <- fig3_dda_psms %>%
                        group_by(Batch) %>%
                        reframe(Batch = unique(Batch),
                                Avg = mean(SumPSM),
                                SD = sd(SumPSM))

fig3_dda_pep_summary  <- fig3_dda_pep %>%
                        group_by(Batch) %>%
                        reframe(Batch = unique(Batch),
                                Avg = mean(Num_Peptides),
                                SD = sd(Num_Peptides)) 
```


PRM runs: Simplifying column names and batch names. Rounding idotp values.

$~$

```{r fig3_prm_data_tidying, results = "hold", collapse = TRUE}
 
fig3_prm_rt_chrom <- fig3_prm_rt_chrom %>% 
                        rename(.,
                              "Replicate" = "Replicate.Name",
                              "Protein.Name" = "Protein")
         
fig3_prm_part <- full_join(fig3_prm_rt_chrom, fig3_prm_metadata, by = c("Replicate","Group"))

fig3_prm <- full_join(fig3_prm_part, fig3_prm_ms1_idotp, by = c("File.Name","Peptide.Modified.Sequence","Protein.Name"))

fig3_prm <- fig3_prm %>% 
             rename(.,
                    "Batch" = "Group")

fig3_prm$Batch <- factor(fig3_prm$Batch, levels=c("2014","2015", "2016-1", "2016-2"))


# Rounding the idotp value to make visualizing them in the chromatograms easier.  
fig3_prm <- fig3_prm %>% 
            mutate(idotp_rounded = format(round(Isotope.Dot.Product, digits = 2), nsmall = 2))

```


<br/><br/>

## Functions


Defined 2 functions with the following input parameters to put together Figure 3:

* fig3_ms1_chromatogram: Plotting the MS1 chromatogram of PRM runs.

  - dataframe: Peak areas, retention times, and chromatography data from DIA sample runs
  
  - replicate_name: Sample replicate to extract chromatograms
  
  - peptide: Peptide sequence to plot
  
  - time_col: Measured times
  
  - intensity_col: Intensity at the measured times
  
  - y_axis_max: Setting a y-axis maximum based on the peak apex wth a buffer
  
  - label_buffer: Setting a buffer between the peak apex and the idotp value label
  
  - x_min_buffer_5: Setting a buffer between early peak edge and y-axis
  
  - x_max_buffer_5: Setting a buffer between late peak edge and graph edge
  
  - x_axis_label: Text of the x-axis label. May be left blank by using "".
  
  - y_axis_label: Text of the y-axis label. May be left blank by using "".
    
  - fig3_subtitle: Used to add a title to the panel. May be left blank by using "".
  
  - fig3_top_margin: Setting margin at the top of the plot area


* fig3_taf: Plotting the average total area fragment of specific peptides PRM runs.

  - dataframe: Peak areas, retention times, and chromatography data from DIA sample runs runs shown in Figure 5.
  
  - peptide: Peptide sequence to plot
  
  - y_axis_maximum: Setting a y-maximum based on the most abundant summed fragment ion peak and adding a buffer.
 
$~$ 


```{r fig3_functions, results = "hold", collapse = TRUE}

fig3_ms1_chromatogram <- function(dataframe, replicate_name, peptide, time_col, intensity_col, y_axis_max, label_buffer, x_min_buffer_5, x_max_buffer_5, x_axis_label, y_axis_label, fig3_subtitle, fig3_top_margin, legend_string, date_label){

  subdata <- dataframe %>%
             filter(Replicate == replicate_name) %>%
             filter(Peptide.Modified.Sequence == peptide) %>%
             filter(Fragment.Ion == "precursor" | Fragment.Ion == "precursor [M+1]" | Fragment.Ion == "precursor [M+2]") %>%
             rename("Time" = time_col, 
                    "Intensity" = intensity_col)

  subdata_renamed <- subdata
  subdata_renamed$Fragment.Ion <- gsub('precursor [M+2]', paste0('M+2'), subdata_renamed$Fragment.Ion, fixed = TRUE)
  subdata_renamed$Fragment.Ion <- gsub('precursor [M+1]', paste0('M+1'), subdata_renamed$Fragment.Ion, fixed = TRUE)
  subdata_renamed$Fragment.Ion <- gsub("precursor", paste0('M'), subdata_renamed$Fragment.Ion)

    subdata_chromatogram <- subdata_renamed %>%
                     separate_longer_delim(., cols = c("Time", "Intensity"), delim = ",") %>%
                     group_by(Fragment.Ion)

  subdata_chromatogram <- transform(subdata_chromatogram, Time = as.numeric(Time))
  subdata_chromatogram <- transform(subdata_chromatogram, Intensity = as.numeric(Intensity))

chrom_x_min <- (min(subdata_chromatogram$Best.Retention.Time) - x_min_buffer_5)
chrom_x_max <- (max(subdata_chromatogram$Best.Retention.Time) + x_max_buffer_5)

chrom_label_y <- ((max(subdata_chromatogram$Intensity))+(max(subdata_chromatogram$Intensity)*label_buffer))
chrom_label_x <- (median(subdata_chromatogram$Best.Retention.Time))
chrom_idotp <- (unique(subdata_chromatogram$idotp_rounded))

chromatogram_plot  <-  (ggplot(subdata_chromatogram, 
              aes(group = Fragment.Ion,
                  color = Fragment.Ion,
                  x = Time,
                  y =  Intensity)) +
 
  geom_line(linewidth = 1.5) +
               theme_minimal()+
               theme(plot.margin = margin(fig3_top_margin, 0, 0, 0.05, "in"),  # t, r, b, l
                     panel.grid.major.x = element_blank(),
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=5, b=0, l=10)),
                     axis.title.x = element_text(size = 22, color = "black", hjust = 0.5, margin = margin(t = 0, r = 0, b = 0, l = 0)),
                     axis.title.y = element_text(size = 22, color = "black", margin = margin(t = 0, r = 0, b = 0, l = 0)),
                     legend.position = legend_string,
                     legend.title = element_text(size = 20),
                     legend.text = element_text(size = 20),
                     legend.margin=margin(c(0,0,0,0), "in"),
                     legend.spacing.x = unit(0.1, "in"),  
                     legend.key.size = unit(0.4, "in"),
                     plot.title=element_text(size=24, color = "black", hjust = 0),
                     plot.subtitle=element_text(size=22, hjust=0.5, color="black")) +
                ggtitle(fig3_subtitle,
                        subtitle = date_label) +
                guides(color=guide_legend(nrow=1)) +
                scale_color_manual(name = "Fragment Ions", values = ms1_Palette) +
                scale_x_continuous(name=x_axis_label, limits=c(chrom_x_min, chrom_x_max)) +
                scale_y_continuous(name=y_axis_label, limits=c(0, y_axis_max)) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=chrom_x_min, linetype="solid", color = "black", linewidth=1)) +
                annotate("text", x = chrom_label_x, y = chrom_label_y, label = chrom_idotp, size = 9)


chromatogram_plot

}



fig3_taf <- function(dataframe, peptide, y_axis_maximum){


fig3_subdata <- dataframe %>%
                 filter(Peptide.Modified.Sequence == peptide) %>%
                 group_by(Batch) %>%
                 reframe(Batch = unique(Batch),
                         Avg = mean(Total.Area.Fragment),
                         SD = sd(Total.Area.Fragment))

  # Plot TAF
    Plot_fig3_PRM_prtc_taf <- (ggplot(data=fig3_subdata, aes(x=Batch, y=Avg, fill=Batch)) +
                               geom_bar(stat = "identity", fun = "mean") +
                                geom_errorbar(aes(ymin=Avg-SD, ymax=Avg+SD), width=.2, position=position_dodge(.9)) +
                                theme_minimal()+
                                theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l
                                      panel.grid.major.x = element_blank(),
                                      panel.grid.major.y = element_line(color="azure3"),
                                      panel.grid.minor.x = element_blank(),
                                      panel.grid.minor.y = element_blank(),
                                      axis.text.x = element_text(size=16, color = "black",angle = 90, vjust = 0.5, hjust=1),
                                      axis.text.y = element_text(size=16, color = "black"),
                                      axis.title.x = element_blank(),
                                      axis.title.y = element_text(size = 18, color = "black", margin = margin(t = 0, r = 0, b = 0, l = 0)),
                                      legend.position = "none",
                                      plot.title=element_text(size=21, color = "black", hjust = 0)) +
                                 ggtitle(paste0("PRM: ",peptide)) +
                                 geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=0) +
                                 ylim(0,((y_axis_maximum)+(y_axis_maximum*.05))) +
                                 scale_x_discrete(name="Run Date", labels=c("2014" = "12/2014", "2015" = "04/2015", "2016-1" = "02/2016", "2016-2" = "03/2016")) + 
                                 scale_y_continuous(name="Total Area Fragment") +
                                 scale_fill_manual(values = c("2014" = cbPalette[1], "2015" = cbPalette[8], "2016-1" = cbPalette[6], "2016-2" = cbPalette[2])))

Plot_fig3_PRM_prtc_taf
}

```

<br/><br/>

## Figure 3

**NOTE:** Code generates all components of Figure 3, however manual changes to center labels were done in Inkscape:

* The "Fragment Ion" label was moved to the right into x position 700

* The legend keys were moved to the right into x position 665

* The x-axis label "Time (Minutes)" label was moved to the right into x position 700


<br/><br/>

**Shared Color Palettes**

Setting-up colorblind-friendly color palettes to use in Figure 3.

$~$

```{r fig3_color_palette}
# Figure 3 MS1 chromatogram color palette
  # ms1_Palette <- c("#000999", "#009E73","#D55E00")
  ms1_Palette <- c("#D55E00", "#009E73","#000999")

# Figure 3 color palette for DDA PSMs and peptide IDs, and PRM TAF.
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000")

```

<br/><br/>

**Figure 3A**

Generating a ggplot object of a timeline of significant maintenance.

$~$

```{r}
# Setting-up dataframe to plot timeline of maintenance and data in figure 3
fig3_timeline <- data.frame("Position_x" = c(-225, -200, -75, -50, 75, 100, 115, 285), 
                            "Position_y" = c(45, 5, 45, 5, 55, 35, 5, 5),
                            "Orientation"= c(1, -1, 1, -1, 1, 1, -1, -1),
                            "Note"= c("New RF coil, LIT, software", "12/2014", "Cleaned optics",  
                                      "04/2015", "Cleaned optics, isolation quad", "Cleaned optics, q0",
                                      "02/2016", "03/2016"))

```


```{r fig3a_plot, fig.dim = c(20,2.441), fig.show='hide', results = "hold", collapse = TRUE, warning = FALSE, message = FALSE}

## Plotting rough maintenance timeline to correspond with the data in 3B-G
figure3a <- (ggplot(data = fig3_timeline, aes(x=Position_x, y=Position_y)) +
          theme_void()+
          theme(plot.margin = margin(0.2, 0, 0.4, 0, "in"),  # t, r, b, l 
                axis.title.x=element_blank(),
                axis.title.y=element_blank(),
                axis.text.x=element_blank(),
                axis.text.y=element_blank(),
                axis.ticks.x=element_blank(),
                axis.ticks.y=element_blank(),
                axis.line.x=element_blank(),
                axis.line.y=element_blank()) +
          coord_fixed(xlim=c(0,100),
                  ylim = c(0, 75),
                  clip = 'off') +   
          geom_segment(data=fig3_timeline, aes(y=20,yend=20,x=-250,xend=350), color='black', size=3) +

          annotate("text", x = 50, y = 75, label="Significant Maintenance Timeline", colour = "black", size=9) +
          geom_segment(data=fig3_timeline, aes(y=20,yend=(Position_y+(1.5*Orientation)),x=Position_x,xend=Position_x), color='black', size=1) +
          geom_point(data = fig3_timeline, aes(x=Position_x, y=20), size=8, shape=21, fill = "azure4", colour = "black") +

          geom_label(data=fig3_timeline, aes(x=Position_x, y=(Position_y+(1.5*Orientation)),label=Note),size=7,vjust=0.5,hjust= 0.05,color='black') #+

)

figure3a


```


<br/><br/>

**Figure 3B, 3C, 3F, and 3G**

Generating representative chromatograms of one sample per troubleshooting batch for one PRTC peptide (GLILVGGYGTR, panel B) and one enolase peptide (LVNELTEFAK, panel C), and the bar plots representing the average total area fragment of the same peptides (GLILVGGYGTR, panel B; LVNELTEFAK, panel C).

$~$

```{r fig3B_3C_3F_3G_plots, fig.show='hide', results = "hold", collapse = TRUE}
# Shared variables
fig3_panel_w <- 5
fig3_panel_h <- 5

fig3_shared_x <- "Time (Minutes)"
fig3_shared_y <- "Intensity"

rep_2014 <- "2014_12_5"
rep_2015 <- "2015_4_2"
rep_2016 <- "2016_2_2"
rep_2016_2 <- "2016_3_5"


fig3_bsa <- "LVNELTEFAK"
fig3_bsa_yax <- (2.3e9)

fig3_prtc <- "GLILVGGYGTR"  #Coalescence in 2016
fig3_prtc_yax <- (750e6)

fig3_prtc2 <- "GISNEGQNASIK"  # Coalescence everywhere
fig3_prtc2_yax <- (725e6)


fig3_prtc_2014_chrom <- fig3_ms1_chromatogram(dataframe = fig3_prm, 
                                              replicate_name = rep_2014, 
                                              peptide = fig3_prtc, 
                                              time_col ="Raw.Times", 
                                              intensity_col = "Raw.Intensities", 
                                              y_axis_max = fig3_prtc_yax, 
                                              label_buffer = 0.3,  
                                              x_min_buffer_5 = 0.15, 
                                              x_max_buffer_5 = 0.15, 
                                              x_axis_label = "", 
                                              y_axis_label = fig3_shared_y, 
                                              fig3_subtitle = fig3_prtc, 
                                              fig3_top_margin = 0.075,
                                              legend_string = "none",
                                              date_label = "12/2014")

fig3_prtc_2015_chrom <- fig3_ms1_chromatogram(dataframe = fig3_prm, 
                                              replicate_name = rep_2015, 
                                              peptide = fig3_prtc, 
                                              time_col ="Raw.Times", 
                                              intensity_col = "Raw.Intensities", 
                                              y_axis_max = fig3_prtc_yax, 
                                              label_buffer = 0.4,
                                              x_min_buffer_5 = 0.2, 
                                              x_max_buffer_5 = 0.4, 
                                              x_axis_label = "", 
                                              y_axis_label = "", 
                                              fig3_subtitle = "", 
                                              fig3_top_margin = 0.075,
                                              legend_string = c(0.5, 1.3),
                                              date_label = "04/2015")
                     
fig3_prtc_2016_chrom <- fig3_ms1_chromatogram(dataframe = fig3_prm, 
                                              replicate_name = rep_2016, 
                                              peptide = fig3_prtc, 
                                              time_col ="Raw.Times", 
                                              intensity_col = "Raw.Intensities", 
                                              y_axis_max = fig3_prtc_yax, 
                                              label_buffer = 0.085,  
                                              x_min_buffer_5 = 0.2, 
                                              x_max_buffer_5 = 0.2, 
                                              x_axis_label = "", 
                                              y_axis_label = "", 
                                              fig3_subtitle = "", 
                                              fig3_top_margin = 0.075,
                                              legend_string = "none",
                                              date_label = "02/2016")

fig3_prtc_2016_2_chrom <- fig3_ms1_chromatogram(dataframe = fig3_prm, 
                                                replicate_name = rep_2016_2, 
                                                peptide = fig3_prtc, 
                                                time_col ="Raw.Times", 
                                                intensity_col = "Raw.Intensities", 
                                                y_axis_max = fig3_prtc_yax, 
                                                label_buffer = 0.15,  
                                                x_min_buffer_5 = 0.2, 
                                                x_max_buffer_5 = 0.2, 
                                                x_axis_label = "", 
                                                y_axis_label = "", 
                                                fig3_subtitle = "", 
                                                fig3_top_margin = 0.075,
                                                legend_string = "none",
                                                date_label = "03/2016")

fig3_prtc_taf <- fig3_taf(dataframe = fig3_prm, 
                          peptide = fig3_prtc, 
                          y_axis_maximum = (450e6))




fig3_bsa_2014_chrom <- fig3_ms1_chromatogram(dataframe = fig3_prm, 
                                             replicate_name = rep_2014, 
                                             peptide = fig3_bsa, 
                                             time_col ="Raw.Times", 
                                             intensity_col = "Raw.Intensities", 
                                             y_axis_max = fig3_bsa_yax,
                                             label_buffer = 0.4, 
                                             x_min_buffer_5 = 0.15, 
                                             x_max_buffer_5 = 0.15, 
                                             x_axis_label = fig3_shared_x, 
                                             y_axis_label = fig3_shared_y, 
                                             fig3_subtitle = fig3_bsa, 
                                             fig3_top_margin = 0.05,
                                             legend_string = "none",
                                             date_label = "12/2014")

fig3_bsa_2015_chrom <- fig3_ms1_chromatogram(dataframe = fig3_prm, 
                                             replicate_name = rep_2015, 
                                             peptide = fig3_bsa, 
                                             time_col ="Raw.Times", 
                                             intensity_col = "Raw.Intensities", 
                                             y_axis_max = fig3_bsa_yax, 
                                             label_buffer = 0.4, 
                                             x_min_buffer_5 = 0.2, 
                                             x_max_buffer_5 = 0.4, 
                                             x_axis_label = "", 
                                             y_axis_label = "", 
                                             fig3_subtitle = "", 
                                             fig3_top_margin = 0.05,
                                             legend_string = "none",
                                             date_label = "04/2015")

fig3_bsa_2016_chrom <- fig3_ms1_chromatogram(dataframe = fig3_prm, 
                                             replicate_name = rep_2016, 
                                             peptide = fig3_bsa, 
                                             time_col ="Raw.Times", 
                                             intensity_col = "Raw.Intensities", 
                                             y_axis_max = fig3_bsa_yax, 
                                             label_buffer = 0.2, 
                                             x_min_buffer_5 = 0.2, 
                                             x_max_buffer_5 = 0.2, 
                                             x_axis_label = "", 
                                             y_axis_label = "", 
                                             fig3_subtitle = "", 
                                             fig3_top_margin = 0.05,
                                             legend_string = "none",
                                             date_label = "02/2016")

fig3_bsa_2016_2_chrom <- fig3_ms1_chromatogram(dataframe = fig3_prm, 
                                               replicate_name = rep_2016_2, 
                                               fig3_bsa, 
                                               time_col ="Raw.Times", 
                                               intensity_col = "Raw.Intensities", 
                                               y_axis_max = fig3_bsa_yax,
                                               label_buffer = 0.15, 
                                               x_min_buffer_5 = 0.2, 
                                               x_max_buffer_5 = 0.2, 
                                               x_axis_label = "", 
                                               y_axis_label = "", 
                                               fig3_subtitle = "", 
                                               fig3_top_margin = 0.05,
                                               legend_string = "none",
                                               date_label = "03/2016")

fig3_bsa_taf <- fig3_taf(dataframe = fig3_prm, 
                         peptide = fig3_bsa, 
                         y_axis_maximum = (450e6))


```


<br/><br/>

**Figure 3E and 3F**

Generating bar plots representing the average PSMs identified per batch (panel E) and the average peptide identified (panel F) in DDA runs for each batch.

$~$

```{r fig3D_3E_plots, fig.show='hide', results = "hold", collapse = TRUE}

# Plot peptides
    fig3_DDA_Peptide <- (ggplot(data=fig3_dda_pep_summary, aes(x=Batch, y=Avg, fill=Batch)) +
                           geom_bar(stat = "identity", fun = "mean") +
                          geom_errorbar(aes(ymin=Avg-SD, ymax=Avg+SD), width=.2, position=position_dodge(.9)) +
                          theme_minimal()+
                          theme(plot.margin = margin(0.3, 0, 0, 0, "in"),  # t, r, b, l
                                panel.grid.major.x = element_blank(),
                                panel.grid.major.y = element_line(color="azure3"),
                                panel.grid.minor.x = element_blank(),
                                panel.grid.minor.y = element_blank(),
                                axis.text.x = element_text(size=16, color = "black",angle = 90, vjust = 0.5, hjust=1),
                                axis.text.y = element_text(size=16, color = "black"),
                                axis.title.x = element_blank(),
                                axis.title.y = element_text(size = 18, color = "black", margin = margin(t = 0, r = 0, b = 0, l = 0)),
                                plot.title=element_text(size=21, color = "black", hjust = 0),
                                legend.position = "none"
                                ) +
                          ggtitle("DDA: Peptides") +
                          geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=0.5) +
                          ylim(0,(max(fig3_dda_pep$Num_Peptides)+(max(fig3_dda_pep$Num_Peptides)*.05))) +
                          scale_x_discrete(name="Run Date", labels=c("2014" = "12/2014", "2015" = "04/2015", "2016-1" = "02/2016", "2016-2" = "03/2016")) + 
                          scale_y_continuous(name="Average Peptides", breaks=c(2500,5000,7500)) +
                          scale_fill_manual(values = c("2014" = cbPalette[1], "2015" = cbPalette[8], "2016-1" = cbPalette[6], "2016-2" = cbPalette[2])))


    fig3_DDA_PSM <- (ggplot(data=fig3_dda_psms_summary, aes(x=Batch, y=Avg, fill=Batch)) +
                       geom_bar(stat = "identity", fun = "mean") +
                          geom_errorbar(aes(ymin=Avg-SD, ymax=Avg+SD), width=.2, position=position_dodge(.9)) +
                          theme_minimal()+
                          theme(plot.margin = margin(0.3, 0, 0, 0, "in"),  # t, r, b, l 
                                panel.grid.major.x = element_blank(),
                                panel.grid.major.y = element_line(color="azure3"),
                                panel.grid.minor.x = element_blank(),
                                panel.grid.minor.y = element_blank(),
                                axis.text.x = element_text(size=16, color = "black",angle = 90, vjust = 0.5, hjust=1),
                                axis.text.y = element_text(size=16, color = "black"),
                                axis.title.x = element_blank(),
                                axis.title.y = element_text(size = 18, color = "black", margin = margin(t = 0, r = 0, b = 0, l = 0)),
                                plot.title=element_text(size=21, color = "black", hjust = 0),
                                legend.position = "none"
                                ) +
                          ggtitle("DDA: PSMs") +
                          geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=0.5) +
                          ylim(0,(max(fig3_dda_pep$Num_Peptides)+(max(fig3_dda_pep$Num_Peptides)*.05))) +
                          scale_x_discrete(name="Run Date", labels=c("2014" = "12/2014", "2015" = "04/2015", "2016-1" = "02/2016", "2016-2" = "03/2016")) + 
                          scale_y_continuous(name="Average PSMs", breaks=c(3000,6000,9000,12000)) +
                          scale_fill_manual(values = c("2014" = cbPalette[1], "2015" = cbPalette[8], "2016-1" = cbPalette[6], "2016-2" = cbPalette[2])))

```

<br/><br/>

**Figure 3**

Combining panels A-F to generate Figure 3.

$~$

```{r figure3_plot, fig.show='hide', results = "hold", collapse = TRUE}


# Setting up layout for final figure to assemble all panels of Supplementary Figure S1. Order important for proper annotations.  
  fig3_layout <- c(
      area(t = 1, l = 1, b = 1, r = 4),
      area(t = 2, l = 1, b = 2, r = 1),
      area(t = 2, l = 2, b = 2, r = 2),
      area(t = 2, l = 3, b = 2, r = 3),
      area(t = 2, l = 4, b = 2, r = 4),
      area(t = 3, l = 1, b = 3, r = 1),
      area(t = 3, l = 2, b = 3, r = 2),
      area(t = 3, l = 3, b = 3, r = 3),
      area(t = 3, l = 4, b = 3, r = 4),
      area(t = 4, l = 1, b = 4, r = 1),
      area(t = 4, l = 2, b = 4, r = 2),
      area(t = 4, l = 3, b = 4, r = 3),
      area(t = 4, l = 4, b = 4, r = 4)
      )

     fig3 <- (figure3a + fig3_prtc_2014_chrom + fig3_prtc_2015_chrom + fig3_prtc_2016_chrom + fig3_prtc_2016_2_chrom + fig3_bsa_2014_chrom + fig3_bsa_2015_chrom + fig3_bsa_2016_chrom + fig3_bsa_2016_2_chrom + fig3_DDA_PSM + fig3_DDA_Peptide + fig3_prtc_taf + fig3_bsa_taf + plot_layout(design = fig3_layout) + plot_annotation(tag_levels = list(c("A", "B",  "", "", "", "C", "", "", "", "D", "E", "F", "G"))) & theme(plot.tag = element_text(size = 28)))

# Export Figure 3 as .svg file
  ggsave(file = paste("output\\figures\\",basename,filenamebase,"Figure3_partial.svg", sep=""), plot=fig3, width= 20, height=18.4) 

```

<br/><br/>

```{r figure3_printed, fig.dim = c(20,17), results = "hold", collapse = TRUE}
# Print Figure 3  
  fig3

```


<br/><br/>



# Figure 4, Supplemental Figure 1 {.tabset .tabset-fade}


<br/><br/>

## Tidying

Merging data and metadata.

$~$

```{r fig4andS1_data_tidying, results = "hold", collapse = TRUE}
# Select PRTC peptides for figure generation
fig4_YENO1 <- "VNQIGTLSESIK"
figS1_YENO1 <- c("AADALLLK", "VNQIGTLSESIK")
figS1_PRTC <- c("NGFILDGFPR","TASEFDSAIAQDK")

fig4_pa_rt_chrom_grouped <- fig4_pa_rt_chrom %>%
                            rename("Replicate" = "Replicate.Name") %>%
                            group_by(Replicate,Peptide.Modified.Sequence,Fragment.Ion) %>%
                            merge(., fig4_meta, by = c("Replicate", "Group"))


fig4_pa_rt_chrom_grouped_ms2 <- fig4_pa_rt_chrom_grouped %>%
                                filter(Fragment.Ion != "precursor") %>%
                                filter(Fragment.Ion != "precursor [M+1]") %>%
                                filter(Fragment.Ion != "precursor [M+2]")

colnames(fig4_pa_rt_chrom_grouped_ms2)

```
<br/><br/>

## Functions

**Functions to produce Figure 4**

Defined 2 functions to put together Figure 4:

* fig4_eno_runorder: Peptides plotted in run order. Includes graph title and y-axis title. No x-axis title.

* fig4_eno_group: Peptides plotted in groups. Includes y-axis title. No graph title or x-axis title.


Functions require a dataframe, sample replicate, peptide sequence to plot, measured time, measured intensity, y-axis maximum, x-axis minimum buffer (Distance between peak edge), and x-axis maximum buffer (Distance between peak edge).

* dataframe:Peak areas, retention times, and chromatography data from DIA sample runs

* peptide_sequence: Sequence of peptides to extract fragment ion area

* fig4ymax: Setting a y-maximum based on the most abundant summed fragment ion peak and adding a buffer

$~$

```{r fig4_functions,results = "hold", collapse = TRUE}

# Variables to fill-out within the same chunk:
    # Shared variables
        # - legtitle = Legend title (In this case, it's "Fragment")
    
    # Individual panels
        # - fig4_plottitle = Plot title is the peptide plotted, where needed.
        # - cbPalette = Color palette which attempts to be colorblind-friendly.
            # ^ NOTE: Define separate palette for each panel. Number of colors depends on the number of peptide fragments.
        # - vertical_lines = Points where vertical lines are needed to separate groups in the grouped panel

fig4_eno_runorder <- function(dataframe, peptide_sequence, fig4ymax){
  
  f4_subdata <- (dataframe %>%
                 filter(Peptide.Modified.Sequence == peptide_sequence) %>%
                 group_by(Fragment.Ion))

  ggplot(f4_subdata,
              aes(group = Fragment.Ion,
                  fill = Fragment.Ion,
                  x = reorder(Replicate, Run.Order),
                  y =  Area)) +
  
  geom_bar(position="stack", stat="identity", width=0.75) +
               theme_minimal()+
               theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l 
                     panel.grid.major.x = element_blank(),        
                     panel.grid.major.y = element_line(color="azure3", linewidth = 0.1),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=0.5, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=0.1, b=0, l=0.1)),
                     axis.title=element_text(size=22, color = "black"),
                     legend.position = "none",
                     plot.title=element_text(size=22, color = "black", hjust = 0.5)
                     ) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=0.5, linetype="solid", color = "black", linewidth=1) +
                ggtitle((fig4_plottitle)) +
                scale_fill_manual(values = fig4_cbPalette) + 
                scale_y_continuous(name=paste0("Area \n (Run Order)"), limits = c(0,fig4ymax)) +
                scale_x_discrete(name="") +
                annotate("text", x = 16.5, y = (fig4ymax), label = "Run Order", size = 9)
}


fig4_eno_group <- function(dataframe, peptide_sequence, fig4ymax){
  
  f4_subdata <- (dataframe %>%
                 filter(Peptide.Modified.Sequence == peptide_sequence) %>%
                 group_by(Fragment.Ion))

  ggplot(f4_subdata,
              aes(group = Fragment.Ion,
                  fill = Fragment.Ion,
                  x = reorder(Replicate, Group.Order),
                  y =  Area)) +
  
  geom_bar(position="stack", stat="identity", width=0.75) +
               theme_minimal()+
               theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l 
                     panel.grid.major.x = element_blank(),        
                     panel.grid.major.y = element_line(color="azure3", linewidth = 0.1),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=0.5, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=0.1, b=0, l=0.1)),
                     axis.title=element_text(size=22, color = "black"),
                     legend.position = "none"
                     ) +
                # guides(fill=guide_legend(title=legtitle)) +
                scale_fill_manual(values = fig4_cbPalette) + 
                scale_x_discrete(name="Replicates") +
                scale_y_continuous(name=paste0("Area \n (Grouped)"), limits = c(0,fig4ymax)) +
                geom_vline(xintercept=vertical_lines, linetype="dashed", color = "black", linewidth=0.5) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=0.5, linetype="solid", color = "black", linewidth=1) +
                annotate("text", x = c(4.5,12.5,20.5,28.5), y = c((fig4ymax),(fig4ymax),(fig4ymax),(fig4ymax)), label = c("1BD","2BD","ISD","STR"), size = 9)
}

```

<br/><br/>

**Functions to produce Supplementary Figure 1**

Defined 4 functions to put together Supplementary Figure 1:

* figS1_runorder_title_nox: Peptides plotted in run order. Includes graph title and y-axis title. No x-axis title.

* figS1_group_notitle_nox: Peptides plotted in groups. Includes y-axis title. No graph title or x-axis title.

* figS1_group_notitle: Peptides plotted in groups. Includes y-axis and x-axis title. No graph title.

* figS1_runorder_title_nox_noy: Peptides plotted in run order. No graph title, y-axis title, or x-axis title.

* figS1_group_notitle_nox_noy: Peptides plotted in groups. No graph title, y-axis title, or x-axis title.

* figS1_group_xaxis_noy: Peptides plotted in groups. Includes graph title and x-axis title. No y-axis title.


Functions require a dataframe, sample replicate, peptide sequence to plot, measured time, measured intensity, y-axis maximum, x-axis minimum buffer (Distance between peak edge), and x-axis maximum buffer (Distance between peak edge).

* dataframe: Peak areas, retention times, and chromatography data from DIA sample runs

* peptide_sequence: Sequence of peptides to extract fragment ion area

* figs1ymax: Setting a y-maximum based on the most abundant summed fragment ion peak and adding a buffer

* figS1_plottitle: Sequence of peptide plotted

* figs1_cbPalette: Color palette

$~$


```{r figS1_functions}
# Additional vvariable
    # figS1_plottitle: 
    # figs1_cbPalette: 


# Panel 1 and 3 - Plotted in MS run order. Including plot title. Does not include the shared x-axis title or legend.
figS1_runorder_title_nox <- function(dataframe, peptide_sequence, figs1ymax, figS1_plottitle, figs1_cbPalette){

    s1_subdata <- (dataframe %>%
                 filter(Peptide.Modified.Sequence == peptide_sequence) %>%
                 group_by(Fragment.Ion))

  ggplot(s1_subdata, 
              aes(group = Fragment.Ion,
                  fill = Fragment.Ion,
                  x = reorder(Replicate, Run.Order),
                  y =  Area)) +
  
  geom_bar(position="stack", stat="identity", width=0.75) +
               theme_minimal()+
               theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l 
                     panel.grid.major.x = element_blank(),        
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black"),
                     axis.title=element_text(size=22, color = "black"),
                     legend.position = "none",
                     plot.title=element_text(size=22, color = "black", hjust = 0.5)
                     ) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=0, linetype="solid", color = "black", linewidth=1) +
                ggtitle(figS1_plottitle) +
                scale_fill_manual(values = figs1_cbPalette) + 
                scale_y_continuous(name=paste0("Area \n (Run Order)")) +
                scale_x_discrete(name="")  +
                annotate("text", x = 16.5, y = (figs1ymax), label = "Run Order", size = 9)
}


# Panel 2 - Grouped by sample preparation method. Not including plot title, the shared x-axis title, or the shared x-axis title.
figS1_group_notitle_nox <- function(dataframe, peptide_sequence, figs1ymax, figs1_cbPalette){
  
  s1_subdata <- (dataframe %>%
                 filter(Peptide.Modified.Sequence == peptide_sequence) %>%
                 group_by(Fragment.Ion))

  ggplot(s1_subdata, 
              aes(group = Fragment.Ion,
                  fill = Fragment.Ion,
                  x = reorder(Replicate, Group.Order),
                  y =  Area)) +
  
  geom_bar(position="stack", stat="identity", width=0.75) +
               theme_minimal()+
               theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l 
                     panel.grid.major.x = element_blank(),        
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=5, b=0, l=10)),
                     axis.title=element_text(size=22, color = "black"),
                     legend.position = "none",
                     plot.title=element_text(size=22, color = "black", hjust = 0.5)
                     ) +
                # guides(fill=guide_legend(title=legtitle)) +
                scale_fill_manual(values = figs1_cbPalette) + 
                scale_x_discrete(name="") +
                scale_y_continuous(name=paste0("Area \n (Grouped)")) +
                geom_vline(xintercept=vertical_lines, linetype="dashed", color = "black", linewidth=0.5) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=0, linetype="solid", color = "black", linewidth=1) +
                annotate("text", x = c(4.5,12.5,20.5,28.5), y = c((figs1ymax),(figs1ymax),(figs1ymax),(figs1ymax)), label = c("1BD","2BD","ISD","STR"), size = 9)
}

# Panel 4 - Grouped by sample preparation method. Not including plot title. Includes the shared x-axis title and the legend of plotted fragments.
figS1_group_notitle <- function(dataframe, peptide_sequence, figs1ymax, figs1_cbPalette){
  
  s1_subdata <- (dataframe %>%
                 filter(Peptide.Modified.Sequence == peptide_sequence) %>%
                 group_by(Fragment.Ion))

  ggplot(s1_subdata, 
              aes(group = Fragment.Ion,
                  fill = Fragment.Ion,
                  x = reorder(Replicate, Group.Order),
                  y =  Area)) +
  
  geom_bar(position="stack", stat="identity", width=0.75) +
               theme_minimal()+
               theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l 
                     panel.grid.major.x = element_blank(),        
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=5, b=0, l=10)),
                     axis.title=element_text(size=22, color = "black"),
                     legend.position = "none",
                     plot.title=element_text(size=22, color = "black", hjust = 0.5)
                     ) +
                # guides(fill=guide_legend(title=legtitle)) +
                scale_fill_manual(values = figs1_cbPalette) + 
                scale_x_discrete(name="Replicates") +
                scale_y_continuous(name=paste0("Area \n (Grouped)")) +
                geom_vline(xintercept=vertical_lines, linetype="dashed", color = "black", linewidth=0.5) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=0, linetype="solid", color = "black", linewidth=1) +
                annotate("text", x = c(4.5,12.5,20.5,28.5), y = c((figs1ymax),(figs1ymax),(figs1ymax),(figs1ymax)), label = c("1BD","2BD","ISD","STR"), size = 9)
}


# Panel 1 and 3 - Plotted in MS run order. Including plot title. Does not include the shared x-axis title or legend.
figS1_runorder_title_nox_noy <- function(dataframe, peptide_sequence, figs1ymax, figS1_plottitle, figs1_cbPalette){
  
  s1_subdata <- (dataframe %>%
                 filter(Peptide.Modified.Sequence == peptide_sequence) %>%
                 group_by(Fragment.Ion))

  ggplot(s1_subdata, 
              aes(group = Fragment.Ion,
                  fill = Fragment.Ion,
                  x = reorder(Replicate, Run.Order),
                  y =  Area)) +
  
  geom_bar(position="stack", stat="identity", width=0.75) +
               theme_minimal()+
               theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l 
                     panel.grid.major.x = element_blank(),        
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black"),
                     axis.title=element_text(size=22, color = "black"),
                     legend.position = "none",
                     plot.title=element_text(size=22, color = "black", hjust = 0.5)
                     ) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=0, linetype="solid", color = "black", linewidth=1) +
                ggtitle(figS1_plottitle) +
                scale_fill_manual(values = figs1_cbPalette) + 
                scale_y_continuous(name="") +
                scale_x_discrete(name="")   +
                annotate("text", x = 16.5, y = (figs1ymax), label = "Run Order", size = 9)
}


# Panel 2 - Grouped by sample preparation method. Not including plot title, the shared x-axis title, or the shared x-axis title.
figS1_group_notitle_nox_noy <- function(dataframe, peptide_sequence, figs1ymax, figs1_cbPalette){
  
  s1_subdata <- (dataframe %>%
                 filter(Peptide.Modified.Sequence == peptide_sequence) %>%
                 group_by(Fragment.Ion))

  ggplot(s1_subdata, 
              aes(group = Fragment.Ion,
                  fill = Fragment.Ion,
                  x = reorder(Replicate, Group.Order),
                  y =  Area)) +
  
  geom_bar(position="stack", stat="identity", width=0.75) +
               theme_minimal()+
               theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l 
                     panel.grid.major.x = element_blank(),        
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=5, b=0, l=10)),
                     axis.title=element_text(size=22, color = "black"),
                     legend.position = "none",
                     plot.title=element_text(size=22, color = "black", hjust = 0.5)
                     ) +
                # guides(fill=guide_legend(title=legtitle)) +
                scale_fill_manual(values = figs1_cbPalette) + 
                scale_x_discrete(name="") +
                scale_y_continuous(name="") +
                geom_vline(xintercept=vertical_lines, linetype="dashed", color = "black", linewidth=0.5) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=0, linetype="solid", color = "black", linewidth=1) +
                annotate("text", x = c(4.5,12.5,20.5,28.5), y = c((figs1ymax),(figs1ymax),(figs1ymax),(figs1ymax)), label = c("1BD","2BD","ISD","STR"), size = 9)
}


# Panel 4 - Grouped by sample preparation method. Not including plot title. Includes the shared x-axis title and the legend of plotted fragments.
figS1_group_xaxis_noy <- function(dataframe, peptide_sequence, figs1ymax, figs1_cbPalette){
  
  s1_subdata <- (dataframe %>%
                 filter(Peptide.Modified.Sequence == peptide_sequence) %>%
                 group_by(Fragment.Ion))

  ggplot(s1_subdata, 
              aes(group = Fragment.Ion,
                  fill = Fragment.Ion,
                  x = reorder(Replicate, Group.Order),
                  y =  Area)) +
  
  geom_bar(position="stack", stat="identity", width=0.75) +
               theme_minimal()+
               theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l 
                     panel.grid.major.x = element_blank(),        
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=5, b=0, l=10)),
                     axis.title=element_text(size=22, color = "black"),
                     legend.position = "none",
                     plot.title=element_text(size=22, color = "black", hjust = 0.5)
                     ) +
                scale_fill_manual(values = figs1_cbPalette) + 
                scale_x_discrete(name="Replicates") +
                scale_y_continuous(name="") +
                geom_vline(xintercept=vertical_lines, linetype="dashed", color = "black", linewidth=0.5) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=0, linetype="solid", color = "black", linewidth=1) +
                annotate("text", x = c(4.5,12.5,20.5,28.5), y = c((figs1ymax),(figs1ymax),(figs1ymax),(figs1ymax)), label = c("1BD","2BD","ISD","STR"), size = 9)
}



```


<br/><br/>

Small functions to print fragments plotted and to extract the maximum summed fragment area.

$~$

```{r fig4_function_print_pep_fragments_max_area}
print_fragments <- function(dataframe, peptide) {
                  
          subdata <- dataframe %>%
                  filter(Peptide.Modified.Sequence == peptide)
                  print(unique(subdata$Fragment.Ion)) }


print_max_area <- function(dataframe, peptide) {
                  
          subdata <- dataframe %>%
                  filter(Peptide.Modified.Sequence == peptide) %>%
                  group_by(Replicate) %>%
                  summarise(replicate = Replicate,
                           summedarea = sum(Area))
                  print(max(subdata$summedarea)) }


```

<br/><br/>

## Figure 4

Assembling Figure 4

$~$

```{r figure4_plot, fig.show='hide', results = "hold", collapse = TRUE}
# Setting additional variables for final plots
    # Shared  variables
      fig4_cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#CC79A7","#D55E00", "#000999")
          # One palette since it's the same peptide in both panels
    
    # Variable only for upper (run order) panel
      fig4_plottitle <- paste0("Yeast Enolase: ",fig4_YENO1)
     
    # Variable only for lower (grouped) panel
      vertical_lines <- c(8.5, 16.5, 24.5)

# Print maximum area plus a buffer for peptide in figure
print_max_area(fig4_pa_rt_chrom_grouped_ms2,fig4_YENO1)+0.25e8


# Top panel
fig4_top <- fig4_eno_runorder(dataframe = fig4_pa_rt_chrom_grouped_ms2, 
                              peptide_sequence = fig4_YENO1, 
                              fig4ymax = (print_max_area(fig4_pa_rt_chrom_grouped_ms2,fig4_YENO1)+0.7e8))
#Bottom panel
figS4_bottom <- fig4_eno_group(dataframe = fig4_pa_rt_chrom_grouped_ms2, 
                               peptide_sequence = fig4_YENO1, 
                               fig4ymax = (print_max_area(fig4_pa_rt_chrom_grouped_ms2,fig4_YENO1)+0.7e8))

# Putting the panels together
fig4_patch <- fig4_top / figS4_bottom
                 
fig4 <- fig4_patch + plot_annotation(tag_levels = 'A') & theme(plot.tag = element_text(size = 6))

# Output Figure 4 as a .svg file. 
ggsave(file = paste("output\\figures\\",basename,filenamebase,"Figure4.svg", sep=""), plot=fig4, width=15, height=15) 

# Output Figure 4 as a .png file. 
ggsave(file = paste("output\\figures\\",basename,filenamebase,"Figure4.png", sep=""), plot=fig4, width=15, height=15) 

```

<br/><br/>

```{r figure4_printed, fig.dim = c(20,15), results = "hold", collapse = TRUE}
# Print Figure 4
  fig4

```
<br/><br/>

## Supplemental Figure S1

Assembling Supplementary Figure 1.

$~$

```{r figureS1_plot, fig.show='hide', results = "hold", collapse = TRUE}
# Shared variable
  vertical_lines <- c(8.5, 16.5, 24.5)

# figS1_YENO1[1]
  # Print fragments for peptide in figure
    print_fragments(fig4_pa_rt_chrom_grouped_ms2,figS1_YENO1[1])
  # Run order
  figS1_pep1_top <- figS1_runorder_title_nox(dataframe = fig4_pa_rt_chrom_grouped_ms2, 
                                             peptide_sequence = figS1_YENO1[1], 
                                             figs1ymax = (print_max_area(fig4_pa_rt_chrom_grouped_ms2,figS1_YENO1[1])+0.55e8),
                                             figS1_plottitle = paste0("Yeast Enolase: ",figS1_YENO1[1]),
                                             figs1_cbPalette = c("#000000", "#009E73", "#999999","#F0E442", "#0072B2", "#D55E00", "#CC79A7"))
  # Grouped by digestion
  figS1_pep1_bottom <- figS1_group_notitle_nox(dataframe = fig4_pa_rt_chrom_grouped_ms2, 
                                               peptide_sequence = figS1_YENO1[1], 
                                               figs1ymax = (print_max_area(fig4_pa_rt_chrom_grouped_ms2,figS1_YENO1[1])+0.55e8),
                                               figs1_cbPalette = c("#000000", "#009E73", "#999999","#F0E442", "#0072B2", "#D55E00", "#CC79A7"))

# figS1_YENO1[2]
  # Print fragments for peptide in figure
    print_fragments(fig4_pa_rt_chrom_grouped_ms2,figS1_YENO1[2])
  # Run order
  figS1_pep2_top <- figS1_runorder_title_nox_noy(dataframe = fig4_pa_rt_chrom_grouped_ms2, 
                                                 peptide_sequence = figS1_YENO1[2], 
                                                 figs1ymax = (print_max_area(fig4_pa_rt_chrom_grouped_ms2,figS1_YENO1[2])+0.7e8),
                                                 figS1_plottitle = paste0("Yeast Enolase: ",figS1_YENO1[2]),
                                                 figs1_cbPalette = c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                                                                     "#0072B2", "#CC79A7","#D55E00", "#000999"))
  # Grouped by digestion
  figS1_pep2_bottom <- figS1_group_notitle_nox_noy(dataframe = fig4_pa_rt_chrom_grouped_ms2, 
                                                   peptide_sequence = figS1_YENO1[2], 
                                                   figs1ymax = (print_max_area(fig4_pa_rt_chrom_grouped_ms2,figS1_YENO1[2])+0.7e8),
                                                   figs1_cbPalette = c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                                                                     "#0072B2", "#CC79A7","#D55E00", "#000999"))

# figS1_PRTC[1]
  # Print fragments for peptide in figure
    print_fragments(fig4_pa_rt_chrom_grouped_ms2,figS1_PRTC[1])
  # Run order
  figS1_pep3_top <- figS1_runorder_title_nox(dataframe = fig4_pa_rt_chrom_grouped_ms2, 
                                             peptide_sequence = figS1_PRTC[1], 
                                             figs1ymax = (print_max_area(fig4_pa_rt_chrom_grouped_ms2,figS1_PRTC[1])+0.65e9),
                                             figS1_plottitle = paste0("PRTC: ",figS1_PRTC[1]),
                                             figs1_cbPalette = c("#000000", "#009E73", "#999999","#F0E442", 
                                                                 "#0072B2", "#D55E00", "#CC79A7"))
  # Grouped by digestion
  figS1_pep3_bottom <- figS1_group_notitle(dataframe = fig4_pa_rt_chrom_grouped_ms2, 
                                           peptide_sequence = figS1_PRTC[1], 
                                           figs1ymax = (print_max_area(fig4_pa_rt_chrom_grouped_ms2,figS1_PRTC[1])+0.65e9),
                                           figs1_cbPalette = c("#000000", "#009E73", "#999999","#F0E442", 
                                                                 "#0072B2", "#D55E00", "#CC79A7"))  
  
# figS1_PRTC[2]
  # Print fragments for peptide in figure
    print_fragments(fig4_pa_rt_chrom_grouped_ms2,figS1_PRTC[2])
  # Run order
  figS1_pep4_top <- figS1_runorder_title_nox_noy(dataframe = fig4_pa_rt_chrom_grouped_ms2, 
                                                 peptide_sequence = figS1_PRTC[2], 
                                                 figs1ymax = (print_max_area(fig4_pa_rt_chrom_grouped_ms2,figS1_PRTC[2])+0.3e9),
                                                 figS1_plottitle = paste0("PRTC: ",figS1_PRTC[2]), 
                                                 figs1_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", 
                                                                     "#F0E442", "#0072B2", "#CC79A7","#D55E00", "#000999"))  
  # Grouped by digestion
  figS1_pep4_bottom <- figS1_group_xaxis_noy(dataframe = fig4_pa_rt_chrom_grouped_ms2, 
                                             peptide_sequence = figS1_PRTC[2], 
                                             figs1ymax = (print_max_area(fig4_pa_rt_chrom_grouped_ms2,figS1_PRTC[2])+0.3e9),
                                             figs1_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73",
                                                                 "#F0E442", "#0072B2", "#CC79A7","#D55E00", "#000999"))  
  
# Setting up layout for final figure to assemble all panels of Supplementary Figure S1. Order important for proper annotations.  
  figS1_layout <- c(
      area(t = 1, l = 1, b = 1, r = 1),
      area(t = 1, l = 2, b = 1, r = 2),
      area(t = 2, l = 1, b = 2, r = 1),
      area(t = 2, l = 2, b = 2, r = 2),
      area(t = 3, l = 1, b = 3, r = 1),
      area(t = 3, l = 2, b = 3, r = 2),
      area(t = 4, l = 1, b = 4, r = 1),
      area(t = 4, l = 2, b = 4, r = 2)
      )

# Generating patchwork of final Supplementary Figure S1.    
    figS1 <- (figS1_pep1_top + figS1_pep2_top + figS1_pep1_bottom + figS1_pep2_bottom + figS1_pep3_top + figS1_pep4_top + figS1_pep3_bottom + figS1_pep4_bottom + plot_layout(design = figS1_layout) + plot_annotation(tag_levels = 'A') & theme(plot.tag = element_text(size = 28)))
    
# Export Supplementary Figure 1 as .svg file
  ggsave(file = paste("output\\figures\\",basename,filenamebase,"FigureS1.svg", sep=""), plot=figS1, width=20, height=30) 

# Export Supplementary Figure 1 as .png file
  ggsave(file = paste("output\\figures\\",basename,filenamebase,"FigureS1.png", sep=""), plot=figS1, width=20, height=30) 

```

<br/><br/>

```{r figureS1_printed, fig.dim = c(20,30), results = "hold", collapse = TRUE}
# Print Supplementary Figure 1
  figS1

```


<br/><br/>


# Figure 5 {.tabset .tabset-fade}


<br/><br/>

## Tidying

Narrowing data to only consider fragment ions and selecting target peptides (Yeast Enolase: AVDDFLISLDGTANK, PRTC: GLILVGGYGTR).

$~$

```{r fig5_data_tidying, results = "hold", collapse = TRUE}

# Select Yeast enolase and PRTC peptides for figure generation
fig5_YENO1 <- "AVDDFLISLDGTANK"
fig5_PRTC <- "GLILVGGYGTR"

fig5_pa_rt_chrom_meta <- fig5_pa_rt_chrom %>%
                            rename("Replicate" = "Replicate.Name") %>%
                            merge(., fig5_meta, by = c("Replicate", "Group"))


fig5_pa_rt_chrom_meta_ms2 <- fig5_pa_rt_chrom_meta %>%
                                filter(Fragment.Ion != "precursor") %>%
                                filter(Fragment.Ion != "precursor [M+1]") %>%
                                filter(Fragment.Ion != "precursor [M+2]")


```

<br/><br/>

## Functions

**Functions to produce Figure 5: Plotting Fragment Ion Intensities**

Function requires a dataframe, peptide sequence to plot, and a subtitle that is used to add a title to the intensity panel. Used the peptide sequence.

* dataframe: Peak areas, retention times, and chromatography data from DIA sample runs

* peptide: Sequence of peptides to extract fragment ion area

* fig5_subtitle: Title showing sequence of peptide

* fig5_cbPalette: Color palette

$~$

```{r fig5_functions_fragmentintensity, fig.show='hide', results = "hold", collapse = TRUE}

fragment_intensity_rep_ylabel <- function(dataframe, peptide, fig5_subtitle, fig5_cbPalette){

  fig5top_subdata <- (dataframe %>%
                      filter(Peptide.Modified.Sequence == peptide))
  
fragment_intensity_plot <- (ggplot(fig5top_subdata, 
                           aes(group = Fragment.Ion,
                              fill = Fragment.Ion,
                              x = factor(Replicate),
                              y =  Area)) +
              
                           geom_bar(position="stack", stat="identity", width=0.85) +
                           theme_minimal()+
                           theme(plot.margin = margin(t = 0.3, r = 0.1, b = 0.1, l = 0.4, unit = "in"),
                                 panel.grid.major.x = element_blank(),        
                                 panel.grid.major.y = element_line(color="azure3"),
                                 panel.grid.minor.x = element_blank(),
                                 panel.grid.minor.y = element_blank(),
                                 axis.text.x = element_text(size=18, color = "black", margin = margin(t=0, r=0, b=10, l=0)),
                                 axis.text.y = element_text(size=18, color = "black"),
                                 axis.title.x = element_text(size = 2, color = "black"),
                                 axis.title.y = element_text(size = 22, color = "black"),
                                 legend.position = "none",
                                 plot.title=element_text(size=22, color = "black", hjust = 0.5)
                                 ) +
                            ggtitle(fig5_subtitle) +
                            geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                            geom_vline(xintercept=0.5, linetype="solid", color = "black", linewidth=1) +
                            scale_fill_manual(values = fig5_cbPalette) +
                            scale_x_discrete(name="") +
                            scale_y_continuous(name="Area"))
fragment_intensity_plot
}


fragment_intensity_rep_nolabel <- function(dataframe, peptide, fig5_subtitle, fig5_cbPalette){

  fig5top_subdata <- (dataframe %>%
                      filter(Peptide.Modified.Sequence == peptide))
  
fragment_intensity_plot <- (ggplot(fig5top_subdata, 
                           aes(group = Fragment.Ion,
                              fill = Fragment.Ion,
                              x = factor(Replicate),
                              y =  Area)) +
              
                           geom_bar(position="stack", stat="identity", width=0.85) +
                           theme_minimal()+
                           theme(plot.margin = margin(t = 0.3, r = 0.1, b = 0.1, l = 0.2, unit = "in"),
                                 panel.grid.major.x = element_blank(),        
                                 panel.grid.major.y = element_line(color="azure3"),
                                 panel.grid.minor.x = element_blank(),
                                 panel.grid.minor.y = element_blank(),
                                 axis.text.x = element_text(size=18, color = "black",  margin = margin(t=0, r=0, b=10, l=0)),
                                 axis.text.y = element_text(size=18, color = "black"),
                                 axis.title.x = element_text(size = 2, color = "black"),
                                 axis.title.y = element_text(size = 22, color = "black"),
                                 legend.position = "none",
                                 plot.title=element_text(size=22, color = "black", hjust = 0.5)
                                 ) +
                            ggtitle(fig5_subtitle) +
                            geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                            geom_vline(xintercept=0.5, linetype="solid", color = "black", linewidth=1) +
                            scale_fill_manual(values = fig5_cbPalette) +
                            scale_x_discrete(name="") +
                            scale_y_continuous(name=" "))
fragment_intensity_plot
  }

```

<br/><br/>

**Functions to produce Figure 5: Plotting Chromatograms of Fragment Ions**

Defined 3 functions to put together Figure 5:

* chromatogram_assigned_peak: Chromatogram with axis titles

* chromatogram_assigned_peak_nolabel: Chromatogram without axis titles

* chromatogram_assigned_peak_zoom: Removed axis titles and zoomed in closer on peak


All 3 functions require a dataframe, sample replicate, peptide sequence to plot, measured time, measured intensity, y-axis maximum, x-axis minimum buffer (Distance between peak edge), and x-axis maximum buffer (Distance between peak edge).

* dataframe: Peak areas, retention times, and chromatography data from DIA sample runs

* replicate_name: Sample replicate to extract chromatograms

* peptide: Peptide sequence to plot

* time_col: Measured times

* intensity_col: Intensity at the measured times

* y_axis_max: Setting a y-axis maximum based on the peak apex wth a buffer

* x_min_buffer_5: Setting a buffer between early peak edge and y-axis

* x_max_buffer_5: Setting a buffer between late peak edge and graph edge

* fig5_cbPalette: Color palette

$~$

```{r fig5_function_chromatogram, fig.show='hide', results = "hold", collapse = TRUE}

chromatogram_assigned_peak <- function(dataframe, replicate_name, peptide, time_col, intensity_col, y_axis_max, x_min_buffer_5, x_max_buffer_5, fig5_cbPalette){

  subdata <- dataframe %>%
             filter(Replicate == replicate_name) %>%
             filter(Peptide.Modified.Sequence == peptide) %>%
             rename("Time" = time_col, 
                    "Intensity" = intensity_col)

    subdata_chromatogram <- subdata %>%
                     separate_longer_delim(., cols = c("Time", "Intensity"), delim = ",") %>%
                     group_by(Fragment.Ion)

  subdata_chromatogram <- transform(subdata_chromatogram, Time = as.numeric(Time))
  subdata_chromatogram <- transform(subdata_chromatogram, Intensity = as.numeric(Intensity))

chrom_x_min <- (min(subdata_chromatogram$Best.Retention.Time) - x_min_buffer_5)
chrom_x_max <- (max(subdata_chromatogram$Best.Retention.Time) + x_max_buffer_5)

chromatogram_plot  <-  (ggplot(subdata_chromatogram, 
              aes(group = Fragment.Ion,
                  color = Fragment.Ion,
                  x = Time,
                  y =  Intensity)) +
 
  geom_line(linewidth = 1.5) +
               theme_minimal()+
               theme(plot.margin = margin(t = 0.3, r = 0.1, b = 0.1, l = 0.4, unit = "in"),
                    panel.grid.major.x = element_blank(),
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=5, b=0, l=10)),
                     axis.title.x = element_text(size = 22, color = "black", hjust = 1),
                     axis.title.y = element_text(size = 22, color = "black"),
                     legend.position = "none"
                     ) +
                scale_color_manual(values = fig5_cbPalette) +
                scale_x_continuous(name="Time (Minutes)", limits=c(chrom_x_min, chrom_x_max)) +
                scale_y_continuous(name="Intensity", limits=c(0, y_axis_max)) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=chrom_x_min, linetype="solid", color = "black", linewidth=1))

chromatogram_plot

}



chromatogram_assigned_peak_nolabel <- function(dataframe, replicate_name, peptide, time_col, intensity_col, y_axis_max, x_min_buffer_5, x_max_buffer_5, fig5_cbPalette){

  subdata <- dataframe %>%
             filter(Replicate == replicate_name) %>%
             filter(Peptide.Modified.Sequence == peptide) %>%
             rename("Time" = time_col, 
                    "Intensity" = intensity_col)

    subdata_chromatogram <- subdata %>%
                     separate_longer_delim(., cols = c("Time", "Intensity"), delim = ",") %>%
                     group_by(Fragment.Ion)

  subdata_chromatogram <- transform(subdata_chromatogram, Time = as.numeric(Time))
  subdata_chromatogram <- transform(subdata_chromatogram, Intensity = as.numeric(Intensity))

chrom_x_min <- (min(subdata_chromatogram$Best.Retention.Time) - x_min_buffer_5)
chrom_x_max <- (max(subdata_chromatogram$Best.Retention.Time) + x_max_buffer_5)

chromatogram_plot  <-  (ggplot(subdata_chromatogram, 
              aes(group = Fragment.Ion,
                  color = Fragment.Ion,
                  x = Time,
                  y =  Intensity)) +
  
  geom_line(linewidth = 1.5) +
               theme_minimal()+
               theme(plot.margin = margin(t = 0.3, r = 0.1, b = 0.1, l = 0.2, unit = "in"),
                     panel.grid.major.x = element_blank(),
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=5, b=0, l=10)),
                     axis.title.x = element_text(size = 22, color = "black"),
                     axis.title.y = element_text(size = 22, color = "black"),
                     legend.position = "none"
                     ) +
                scale_color_manual(values = fig5_cbPalette) +
                scale_x_continuous(name=" ", limits=c(chrom_x_min, chrom_x_max)) +
                scale_y_continuous(name=" ", limits=c(0, y_axis_max)) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=chrom_x_min, linetype="solid", color = "black", linewidth=1))

chromatogram_plot

}


  
chromatogram_assigned_peak_zoom <- function(dataframe, replicate_name, peptide, time_col, intensity_col, y_axis_max, x_min_buffer_5, x_max_buffer_5, fig5_cbPalette){

  subdata <- dataframe %>%
             filter(Replicate == replicate_name) %>%
             filter(Peptide.Modified.Sequence == peptide) %>%
             rename("Time" = time_col, 
                    "Intensity" = intensity_col)

    subdata_chromatogram <- subdata %>%
                     separate_longer_delim(., cols = c("Time", "Intensity"), delim = ",") %>%
                     group_by(Fragment.Ion)

  subdata_chromatogram <- transform(subdata_chromatogram, Time = as.numeric(Time))
  subdata_chromatogram <- transform(subdata_chromatogram, Intensity = as.numeric(Intensity))

chrom_x_min <- (min(subdata_chromatogram$Best.Retention.Time) - x_min_buffer_5)
chrom_x_max <- (max(subdata_chromatogram$Best.Retention.Time) + x_max_buffer_5)

chromatogram_plot  <-  (ggplot(subdata_chromatogram, 
              aes(group = Fragment.Ion,
                  color = Fragment.Ion,
                  x = Time,
                  y =  Intensity)) +
  
  geom_line(linewidth = 1.5) +
               theme_minimal()+
               theme(panel.grid.major.x = element_blank(),
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", angle = 90, margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=5, b=0, l=10)),
                     axis.title = element_blank(),
                     legend.position = "none"
                     ) +
                scale_color_manual(values = fig5_cbPalette) +
                scale_x_continuous(name="Time (Minutes)", limits=c(chrom_x_min, chrom_x_max)) +
                scale_y_continuous(name="Intensity", limits=c(0, y_axis_max)) +
                geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=1) +
                geom_vline(xintercept=chrom_x_min, linetype="solid", color = "black", linewidth=1))

chromatogram_plot

}



```

<br/><br/>

**Functions to produce Figure 5: Retention Time of Fragment Ions**

Function requires a dataframe, sample replicate, peptide sequence to plot, measured time, measured intensity, y-axis maximum, x-axis minimum buffer (Distance between peak edge), and x-axis maximum buffer (Distance between peak edge).

* dataframe: Peak areas, retention times, and chromatography data from DIA sample runs

* peptide: Peptide to extract retention times for.

* late_replicate_name: Replicate with later elution time time to set y-axis boundaries.

* early_replicate_name: Replicate with an earlier elution time to set y-axis boundaries.

* fig5_cbPalette: Color palette

$~$

```{r fig5_functions_RTfragments, fig.show='hide', results = "hold", collapse = TRUE}


  
rt_fragments <- function(dataframe, peptide, late_replicate_name, early_replicate_name, fig5_cbPalette){

  subdata_rt <- dataframe %>%
                filter(Peptide.Modified.Sequence == peptide)
  
subdata_early_replicate <- subdata_rt %>%
                     filter(Replicate == early_replicate_name)

subdata_late_replicate <- subdata_rt %>%
                     filter(Replicate == late_replicate_name)


rt_y_min <- (min(subdata_early_replicate$Min.Start.Time) - 3)
rt_y_max <- (max(subdata_late_replicate$Max.End.Time) + 3)


print(paste0("RT min: ", rt_y_min, " RT max: ", rt_y_max))

transition_rt_plot  <-  (ggplot() + 
              geom_linerange(subdata_rt, 
              mapping = aes(group = interaction(Replicate, Fragment.Ion),
                  color = Fragment.Ion,
                  x = factor(Replicate), 
                  ymin = Min.Start.Time, 
                  ymax = Max.End.Time), position = position_dodge2(width = 0.85, preserve = "single", padding = 0.2), linewidth = 2) +

               theme_minimal()+
               theme(panel.grid.major.x = element_blank(),
                     panel.grid.major.y = element_line(color="azure3"),
                     panel.grid.minor.x = element_blank(),
                     panel.grid.minor.y = element_blank(),
                     axis.text.x = element_text(size=18, color = "black", margin = margin(t=0, r=0, b=10, l=0)),
                     axis.text.y = element_text(size=18, color = "black", margin = margin(t=0, r=5, b=0, l=10)),
                     axis.title = element_text(size=22, color = "black"),
                     legend.position = "none",

                     plot.title=element_text(size=22, color = "black", hjust = 0.5)
                     ) +
                scale_color_manual(values = fig5_cbPalette) +
                scale_x_discrete(name="Replicate") +
                scale_y_continuous(name=paste0("Time (Minutes)"), limits=c(rt_y_min, rt_y_max)) +
                geom_hline(yintercept=rt_y_min, linetype="solid", color = "black", linewidth=1) +# )#+
                geom_vline(xintercept=0.5, linetype="solid", color = "black", linewidth=1))

transition_rt_plot

}
  

```

<br/><br/>

## Figure 5

To finish Figure 5, moved the x-axis labels "Time (Minutes)" to the center of panels C-D and E-F by moving them in Inkscape:

  - x-axis label for panel C-D: Move to the right 130 pixels
  
  - x-axis label for panel #-F:Move to the right 130 pixels

$~$

```{r fig5_individual_plots, fig.show='hide', results = "hold", collapse = TRUE}
# Shared parameters
fig5_panel_w <- 5
fig5_panel_h <- 5
fig5_zoom_w <- 5
fig5_zoom_h <- 5


print_fragments(dataframe = fig5_pa_rt_chrom_meta_ms2, peptide = fig5_YENO1)
print_fragments(dataframe = fig5_pa_rt_chrom_meta_ms2, peptide = fig5_PRTC)

# Plotting the fragment intensities of one yeast enolase peptide and one PRTC peptide
fig5_yeno1_intensity <- fragment_intensity_rep_ylabel(dataframe = fig5_pa_rt_chrom_meta_ms2, 
                                                      peptide = fig5_YENO1, 
                                                      fig5_subtitle = paste0("Yeast Enolase 1:",fig5_YENO1),
                                                      fig5_cbPalette =  c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                                                                          "#0072B2", "#CC79A7","#D55E00", "#000999","#FF0000", "#555555"))

# Plotting the fragment intensities of one PRTC peptide
fig5_prtc_intensity <- fragment_intensity_rep_nolabel(dataframe = fig5_pa_rt_chrom_meta_ms2, 
                                                      peptide = fig5_PRTC, 
                                                      fig5_subtitle = paste0("PRTC:",fig5_PRTC),
                                                      fig5_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                                                                         "#0072B2", "#CC79A7","#D55E00", "#000999","#FF0000", "#555555"))




# Setting the y-axis maximums for the chromatogram plots of one yeast enolase peptide and one PRTC peptide
fig5_yeno1_yax <- (1.3e8)
fig5_prtc_yax <- (4.5e8)
  

# Plotting the raw intensity and raw time columns to generate a chromatogram of one yeast enolase peptide.
  # Sample 7
  fig5_7_yeno1_raw <- chromatogram_assigned_peak(dataframe = fig5_pa_rt_chrom_meta_ms2, 
                                                 replicate_name = "7", 
                                                 peptide = fig5_YENO1, 
                                                 time_col = "Raw.Times", 
                                                 intensity_col = "Raw.Intensities",
                                                 y_axis_max = fig5_yeno1_yax, 
                                                 x_min_buffer_5 = 0.75, 
                                                 x_max_buffer_5 = 1,
                                                 fig5_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                                                                    "#0072B2", "#CC79A7","#D55E00", "#000999","#FF0000", "#555555"))
  # Sample 9, which is a re-injection of Sample 7.
  fig5_9_yeno1_raw <- chromatogram_assigned_peak_nolabel(dataframe = fig5_pa_rt_chrom_meta_ms2, 
                                                         replicate_name = "9", 
                                                         peptide = fig5_YENO1, 
                                                         time_col = "Raw.Times", 
                                                         intensity_col = "Raw.Intensities",
                                                         y_axis_max = fig5_yeno1_yax, 
                                                         x_min_buffer_5 = 0.5, 
                                                         x_max_buffer_5 = 0.5,
                                                         fig5_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442",
                                                                            "#0072B2", "#CC79A7","#D55E00", "#000999","#FF0000", "#555555"))
  # Sample 7, zoomed in for better visualization.
  fig5_7_yeno1_zoom_raw <- chromatogram_assigned_peak_zoom(dataframe = fig5_pa_rt_chrom_meta_ms2, 
                                                           replicate_name = "7", 
                                                           peptide = fig5_YENO1, 
                                                           time_col = "Raw.Times", 
                                                           intensity_col = "Raw.Intensities",
                                                           y_axis_max = (8e6), 
                                                           x_min_buffer_5 = 0.75, 
                                                           x_max_buffer_5 = 1,
                                                           fig5_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442",
                                                                              "#0072B2", "#CC79A7","#D55E00", "#000999","#FF0000", "#555555"))

  

# Plotting the raw intensity and raw time columns to generate a chromatogram of one PRTC peptide.
  # Sample 7
  fig5_7_prtc_raw <- chromatogram_assigned_peak(dataframe = fig5_pa_rt_chrom_meta_ms2, 
                                                replicate_name = "7", 
                                                peptide = fig5_PRTC, 
                                                time_col = "Raw.Times", 
                                                intensity_col = "Raw.Intensities", 
                                                y_axis_max = fig5_prtc_yax, 
                                                x_min_buffer_5 = 0.75, 
                                                x_max_buffer_5 = 1,
                                                fig5_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2",
                                                                   "#CC79A7","#D55E00", "#000999","#FF0000", "#555555"))

  # Sample 9, which is a re-injection of Sample 7.
  fig5_9_prtc_raw <- chromatogram_assigned_peak_nolabel(dataframe = fig5_pa_rt_chrom_meta_ms2, 
                                                        replicate_name = "9", 
                                                        peptide = fig5_PRTC, 
                                                        time_col = "Raw.Times", 
                                                        intensity_col = "Raw.Intensities", 
                                                        y_axis_max = fig5_prtc_yax, 
                                                        x_min_buffer_5 = 0.7, 
                                                        x_max_buffer_5 = 0.7,
                                                        fig5_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442",
                                                                           "#0072B2", "#CC79A7","#D55E00", "#000999","#FF0000", "#555555"))

  # Sample 7, zoomed in for better visualization.
  fig5_7_prtc_zoom_raw <- chromatogram_assigned_peak_zoom(dataframe = fig5_pa_rt_chrom_meta_ms2, 
                                                          replicate_name = "7", 
                                                          peptide = fig5_PRTC, 
                                                          time_col = "Raw.Times", 
                                                          intensity_col = "Raw.Intensities",                                                                 
                                                          y_axis_max = (11E6), 
                                                          x_min_buffer_5 = 0.75, 
                                                          x_max_buffer_5 = 1,
                                                          fig5_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442",
                                                                             "#0072B2", "#CC79A7","#D55E00", "#000999","#FF0000", "#555555"))

    
# Formatting both of the inset plots to not have a letter label in the final patchwork figure
  fig5_7_yeno1_combined <- fig5_7_yeno1_raw + inset_element(fig5_7_yeno1_zoom_raw, 0.4, 0.4, 1, 1, align_to = 'full', ignore_tag = FALSE)
  fig5_7_prtc_combined <- fig5_7_prtc_raw + inset_element(fig5_7_prtc_zoom_raw, 0.4, 0.4, 1, 1, align_to = 'full', ignore_tag = FALSE)
  

# Plotting retention times of fragments 
  # One yeast enolase peptide
  fig5_7_yeno_rt <- rt_fragments(dataframe = fig5_pa_rt_chrom_meta_ms2, 
                                 peptide = fig5_YENO1, 
                                 late_replicate_name = 7, 
                                 early_replicate_name = 1,
                                 fig5_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                                                    "#0072B2", "#CC79A7","#D55E00", "#000999","#FF0000", "#555555"))
  
  # One PRTC peptide.early_replicate_name
  fig5_7_prtc_rt <- rt_fragments(dataframe = fig5_pa_rt_chrom_meta_ms2, 
                                 fig5_PRTC, 
                                 late_replicate_name = 7, 
                                 early_replicate_name = 1,
                                 fig5_cbPalette = c("#000000","#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                                                    "#0072B2", "#CC79A7","#D55E00", "#000999","#FF0000", "#555555"))
    
```

<br/><br/>

**Figure 5**

Assembling the fragment intensities, chromatograms, and retention times of Sample 7 and its re-injection, denoted Sample 9.

$~$

```{r figure5_plot, fig.show='hide', results = "hold", collapse = TRUE}

# Using patchwork package to put the semi-final figure together
    fig5_layout <- c(
      area(t = 1, l = 1, b = 1, r = 2),
      area(t = 1, l = 3, b = 1, r = 4),
      area(t = 2, l = 1, b = 2, r = 1),
      area(t = 2, l = 2, b = 2, r = 2),
      area(t = 2, l = 3, b = 2, r = 3),
      area(t = 2, l = 4, b = 2, r = 4),
      area(t = 3, l = 1, b = 3, r = 2),
      area(t = 3, l = 3, b = 3, r = 4)
      )

fig5 <- (fig5_yeno1_intensity + fig5_prtc_intensity + fig5_7_yeno1_combined + fig5_9_yeno1_raw + fig5_7_prtc_combined + fig5_9_prtc_raw + fig5_7_yeno_rt + fig5_7_prtc_rt + plot_layout(design = fig5_layout) + plot_annotation(tag_levels = list(c("A", "B", "C", "", "D", "E", "", "F", "G", "H"))) & theme(plot.tag.position = c(0, 1), plot.tag = element_text(size = 46, face = 'bold')))

  ggsave(file = paste("output\\figures\\",basename,filenamebase,"Figure5.svg", sep=""), plot=fig5, width=(25), height=(20))  

##############################################################################################################################
##############################################################################################################################
##
##    To finish figure, move "Replicate" x-axis labels to the center of panels C-D and E-F by moving
##
##    - Label for panel C-D: Move to the right 130 pixels
##    - Label for panel #-F:Move to the right 130 pixels

```

<br/><br/>

```{r figure5_printed, fig.dim = c(25,20), results = "hold", collapse = TRUE}
# Print Figure 5 before manual movement of labels in Inkscape.
  fig5

```



<br/><br/>


# Figure 6 {.tabset .tabset-fade}

<br/><br/>


## Tidying

Merged system suitability (SS) data from PRM runs and internal quality control (IQC) data from sample DIA runs.

$~$

```{r fig6_data_tidying, results = "hold", collapse = TRUE}
# Merging metadata and sample data
SS_data <- full_join(SS_TAF, SS_meta, by = "File.Name")

IQC_data <- full_join(IQC_TAF, IQC_meta, by = "File.Name")

# Merging PRM and DIA data
fig6_replicates <- rbind(SS_data, IQC_data)

fig6_replicates <- fig6_replicates %>%
                   rename("Abbreviation_Skyline" = "Replicate")

# Generating rows of "spacers" to merge with the dataframe of the total area fragments from system suitability (PRM) runs and the internal quality controls from sample (DIA) runs.
row_num_fig6_reps <- nrow(fig6_replicates)

fig6_spacer_temp <- fig6_replicates %>%
                    .[-(1:row_num_fig6_reps),]
                

    fig6_spacer_1 <- fig6_spacer_temp %>%
                        add_row("Protein.Name" = "qc|PRTC|PRTC_Thermo", 
                               "Total.Area.Fragment" = NA, 
                               "Peptide.Sequence" = "NGFILDGFPR",
                               "File.Name" = "Spacer.raw", 
                               "Group" = "SS", 
                               "Abbreviation_Skyline" = "Spacer", 
                               "Batch" = "spacer",
                               "ForFigure" = "True")                            

    
    fig6_spacer_2 <- fig6_spacer_temp %>%
                        add_row("Protein.Name" = "qc|PRTC|PRTC_Thermo", 
                               "Total.Area.Fragment" = NA, 
                               "Peptide.Sequence" = "NGFILDGFPR",
                               "File.Name" = "2ndSpace.raw", 
                               "Group" = "SS", 
                               "Abbreviation_Skyline" = "2ndSpace", 
                               "Batch" = "spacer",
                               "ForFigure" = "True")


# Adding spacers to denote large set of runs not shown
fig6_reps_spacer <- rbind(fig6_replicates,fig6_spacer_1,fig6_spacer_2)

fig6_reps_only <- fig6_reps_spacer %>%
                  filter(., ForFigure == "True")

print(sapply(fig6_spacer_1,class))

fig6_summary <- full_join(fig6_reps_only, organizer, by = c("File.Name","Group"))

```

<br/><br/>

Filtering to only use PRTC peptides (Skipping bovine serum albumin in SS runs and yeast enolase in IQC runs). Grouping, reformatting.

$~$

```{r fig6_adding_spacers, fig.show='hide', results = "hold", collapse = TRUE}

# Duplicating fig6_summary dataframe to avoid overwriting
fig6_PRTC <- fig6_summary %>%
                        filter(Protein.Name == "qc|PRTC|PRTC_Thermo") %>%
                        .[order(.$FigureOrder, decreasing = FALSE),]  


# 
fig6_PRTC$Peptide.Sequence <- factor(fig6_PRTC$Peptide.Sequence, levels=unique(fig6_PRTC$Peptide.Sequence))
levels(fig6_PRTC$Peptide.Sequence)
print(sapply(fig6_PRTC, class))

#
fig6_PRTC$PlotGrouping <- factor(fig6_PRTC$PlotGrouping, levels=unique(fig6_PRTC$PlotGrouping))
levels(fig6_PRTC$PlotGrouping )

#
fig6_PRTC$Group <- factor(fig6_PRTC$Group, levels=c("SS","IQC"))
levels(fig6_PRTC$Group) <- list("System Suitability"  = "SS", "Internal QC" = "IQC")
levels(fig6_PRTC$Group)
print(sapply(fig6_PRTC, class))


fig6_tibble <- as_tibble(fig6_PRTC)
print(sapply(fig6_tibble, class))
levels(fig6_tibble$FigureOrder)

#
fig6_tibble$Abbreviation <- gsub("Spacer", paste0('†'), fig6_tibble$Abbreviation)
fig6_tibble$Abbreviation <- gsub("2ndSpace", paste0('‡'), fig6_tibble$Abbreviation)

# 
fig6_tibble$FigureOrder <- as.numeric(as.character(unlist(fig6_tibble$FigureOrder)))
print(sapply(fig6_tibble, class))


```

<br/><br/>

Filtering data to only include the 8 PRTC peptides most often examined in the MacCoss lab.

$~$

```{r fig6_filtering_data, fig.show='hide', results = "hold", collapse = TRUE}
# Filtering to include 8 PRTC peptides out of 15 possible. Represent the most common PRTC peptides the MacCoss lab uses to assess data

  # Vector to filter down to 8 PRTC peptides for simplicity....
  PRTC_fig6 <- c("NGFILDGFPR", "ELGQSGVDTYLQTK", "ELASGLSFPVGFK", "GISNEGQNASIK", "TASEFDSAIAQDK", "GLILVGGYGTR", "SFANQPLEVVYSK", "LTILEELR")
         
fig6_tibble_plotting <- fig6_tibble[fig6_tibble$Peptide.Sequence == PRTC_fig6[1] | fig6_tibble$Peptide.Sequence == PRTC_fig6[2] | fig6_tibble$Peptide.Sequence == PRTC_fig6[3] | fig6_tibble$Peptide.Sequence == PRTC_fig6[4] | fig6_tibble$Peptide.Sequence == PRTC_fig6[5] | fig6_tibble$Peptide.Sequence == PRTC_fig6[6] | fig6_tibble$Peptide.Sequence == PRTC_fig6[7] | fig6_tibble$Peptide.Sequence == PRTC_fig6[8],]

```

<br/><br/>

Setting up shared settings for Figure 6 panels.

$~$

```{r Fig6_shared_settings, results = "hold", collapse = TRUE}
# Shared Labels for line plots
    pdftitle <- "charging_example"
    system_legendval <- "System\nSuitability"
    process_legendval <- "Process\nControls"
    yaxval <- "Total Area Fragment"
    xaxval <- "Run Sequence"

# Setting x-axis limit base value for panel 6A to make labels more easily adjustable.
    avg_x_max <- 62

# Setting y-axis limit base values for panels in 6B to make labels more easily adjustable.
    # System suitability panel - GLILVGGYGTR is most intense peptide
    fig6_max_y_ss <- (fig6_tibble_plotting %>%
                      filter(., Group == "System Suitability") %>%
                      filter(., Peptide.Sequence == "GLILVGGYGTR"))
    avg_y_max_ss <- (max(fig6_max_y_ss$Total.Area.Fragment))

    # Internal QC panel - GLILVGGYGTR is most intense peptide    
    fig6_max_y_iqc <- (fig6_tibble_plotting %>%
                       filter(., Group == "Internal QC") %>%
                       filter(., Peptide.Sequence == "GLILVGGYGTR"))
    avg_y_max_iqc <- (max(fig6_max_y_iqc$Total.Area.Fragment)+500000)


# Figure 6 colorblind-friendly palette.
    fig6_cbPalette <- c("NGFILDGFPR" = "#999999", "ELGQSGVDTYLQTK" = "#E69F00", "ELASGLSFPVGFK" = "#56B4E9", "GISNEGQNASIK" = "#009E73", "TASEFDSAIAQDK" = "#F0E442", "GLILVGGYGTR" = "#0072B2", "SFANQPLEVVYSK" = "#D55E00", "LTILEELR" = "#CC79A7")
           

```


<br/><br/>

## Figure 6

**Figure 6A**

Maintenance timeline comprising Figure 6A.

$~$

```{r fig6a_plot, fig.dim = c(22,2.441), fig.show='hide', results = "hold", collapse = TRUE, warning = FALSE, message = FALSE}
## Plotting rough maintenance timeline to correspond with the data in panel 6B
figure6a <- (ggplot(data = fig6_timeline, aes(x=FigureOrder, y=Position_y)) +
          theme_void()+
          theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l 
                panel.spacing = unit(20, "pt"),
                axis.title.x=element_blank(),
                axis.title.y=element_blank(),
                axis.text.x=element_blank(),
                axis.text.y=element_blank(),
                axis.ticks.x=element_blank(),
                axis.ticks.y=element_blank(),
                axis.line.x=element_blank(),
                axis.line.y=element_blank()) +
          coord_fixed(xlim=c(1,avg_x_max),
                  ylim = c(0, 7.5),
                  clip = 'off') +   
          geom_segment(data=fig6_timeline, aes(y=2.5,yend=2.5,x=-10,xend=72), color='black', size=2) +

          annotate("text", x = 30, y = 7.5, label="5 months of maintenance after turbo failure", colour = "black", size=10) +
          geom_segment(data=fig6_timeline, aes(y=Position_y,yend=(Position_y+(1.5*Orientation)),x=Position_x,xend=Position_x), color='black', size=0.2) +
          geom_point(data = fig6_timeline, aes(x=Position_x, y=Position_y), size=5, shape=21, fill = "azure4", colour = "black") +

          geom_label(data=fig6_timeline, aes(x=Position_x, y=(Position_y+(1.5*Orientation)),label=Note),size=6,vjust=0.5,hjust= 0.05,color='black')

)

```


<br/><br/>

**Figure 6B**

Total area fragment of PRTC peptides in SS and IQC runs used to plot intensity of 8 PRTC peptides in Figure 6B.

Setting up a dataframe containing annotations to put together the final figure.

$~$

```{r fig6b_annotations, fig.show='hide', results = "hold", collapse = TRUE, }
# Setting up a data frame containing numeric positioning and label information to differentiate between instrument batches.

box_bottombuffer <- 0.2e09
box_topbuffer <- 0.4E09

text_buffer <- 0.95E09

annotations <- data.frame(
  xmin = c(0.75, 17.7, 25.7, 41.7, 0, 0, 0, 0),
  xmax = c(17.3, 25.3, 41.3, 62.5, 0, 0, 0, 0),
  ymin = c(((avg_y_max_ss+text_buffer)-box_bottombuffer), ((avg_y_max_ss+text_buffer)-box_bottombuffer), ((avg_y_max_ss+text_buffer)-box_bottombuffer), ((avg_y_max_ss+text_buffer)-box_bottombuffer), 0, 0, 0, 0),
  ymax = c(((avg_y_max_ss+text_buffer)+box_topbuffer), ((avg_y_max_ss+text_buffer)+box_topbuffer), ((avg_y_max_ss+text_buffer)+box_topbuffer), ((avg_y_max_ss+text_buffer)+box_topbuffer), 0, 0, 0, 0),
  x_text = c(5.5, 18, 30, 49, 0, 0, 0, 0),
  y_text = c((avg_y_max_ss+text_buffer), (avg_y_max_ss+text_buffer), (avg_y_max_ss+text_buffer), (avg_y_max_ss+text_buffer), 0, 0, 0, 0),
  label = c("Aug 16 - Aug 19", "Oct 12 - Oct 13", "Oct 29 - Nov 7", "Dec 1 - Dec 5", "", "", "", ""),
  Group = c("System Suitability", "System Suitability", "System Suitability", "System Suitability","Internal QC", "Internal QC", "Internal QC", "Internal QC")
)

annotations$Group <- factor(annotations$Group, levels=c("System Suitability","Internal QC"))
levels(annotations$Group)
print(sapply(annotations, class))

# Setting colors for rectangles behind data
box_colors <- c("#FCFAC7","#CFE0FC","#F1D0F2", "azure3","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF")

```

<br/><br/>

Plotting Figure 6B with annotations.

$~$

```{r fig6b_plot, fig.show='hide', results = "hold", collapse = TRUE}

# Generating Figure 6. Plotting system suitability and sample internal QCs
figure6b <- (ggplot(data=fig6_tibble_plotting, aes(x=reorder(Abbreviation,FigureOrder), colour=Peptide.Sequence, group=interaction(PlotGrouping, Peptide.Sequence))) +
                
  # Plotting System suitability and internal quality controls on separate panels using facet_grid()
      geom_line(aes(y=as.numeric(Total.Area.Fragment)), size = 1.5)+

      geom_point(aes(y=as.numeric(Total.Area.Fragment)), size = 3.5)+

    
  # Annotating separation between runs.
      annotate("segment", x = c(17.5, 25.5, 41.5), xend = c(17.5, 25.5, 41.5), y = c(0, 0, 0), yend = c(avg_y_max_iqc, avg_y_max_iqc, avg_y_max_iqc), linetype="dashed", colour = "darkgray", linewidth=1, alpha=0.4)+

  # Annotating separation between runs.  
      annotate("rect", xmin = 34.5, xmax = 35.5, ymin = 0, ymax = (avg_y_max_iqc-0.075e9), fill = "azure3", alpha = 0.4) +
      annotate("rect", xmin = 55.5, xmax = 56.5, ymin = 0, ymax = (avg_y_max_iqc-0.075e9), fill = "azure3", alpha = 0.4) +
      annotate("text", x = "†", y = 2.5E09, label=paste0('†'), colour = "black", size=10)+
      annotate("text", x = "‡", y = 2.5E09, label=paste0('‡'), colour = "black", size=10)+

    
      geom_rect(data = annotations, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, group = Group), fill = box_colors, inherit.aes = FALSE, alpha = 1, color = "azure4") +
    
      geom_text(data = annotations, aes(x = x_text, y = y_text, label = label, group = Group), hjust = 0, vjust = 0, inherit.aes = FALSE, size = 8) +

    # Aesthetic and theme changes for the plot
      theme_minimal()+
      theme(plot.margin = margin(0, 0, 0, 0, "in"),  # t, r, b, l 
            panel.grid.major.x = element_blank(),
            panel.grid.major.y = element_line(color="azure3"),
            panel.grid.minor.y = element_line(color="azure3"),
            axis.title=element_text(size=17),
            axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=16, color = "black"),
            axis.text.y = element_text(size=16, color = "black"),
            legend.position = "bottom",
            legend.title=element_blank(),
            legend.text=element_text(size = 11),
            axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
            strip.text.y = element_text(size = 18),
            panel.spacing = unit(20, "pt"),
            plot.caption = element_text(color = "black", size = 20, hjust = 0))+
      geom_hline(yintercept=0, linetype="solid", color = "black", linewidth=0.5) +
      ylab(yaxval) +
      xlab(xaxval) +
      scale_color_manual(values = fig6_cbPalette)+

    # Specific command to plot System suitability and internal quality controls on separate panels using facet_grid()
      facet_grid(rows = vars(Group), scales = "free_y") +

      # Adding note about run breaks
      labs(caption = paste0("† 73 runs\n‡ 14 runs")) #+

  )

```

<br/><br/>

**Figure 6**

Combining the maintenance timeline in Figure 6A and the TAF of PRTC peptides in Figure 6B to generate the final annotated Figure 6.

$~$

```{r}

fig6 <- (figure6a / figure6b + plot_layout(heights = c(1,4)) + plot_annotation(tag_levels = 'A') & theme(plot.tag = element_text(size = 35)))

ggsave(file = paste("output\\figures\\",basename,filenamebase,"Figure6.svg", sep=""), plot=fig6, width=22, height=(11+2.441))  
  
```

<br/><br/>

```{r figure6_printed, fig.dim = c(22,13.441), results = "hold", collapse = TRUE}
# Print Figure 6
  fig6

```
